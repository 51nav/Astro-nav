---
/**
 * é”™è¯¯æ¶ˆæ¯ç»„ä»¶
 * Week 3 - ä»»åŠ¡2.3
 */

import type { ErrorType, ErrorSeverity } from '../utils/ErrorHandler';

export interface Props {
  /** é”™è¯¯ç±»å‹ */
  type?: ErrorType | string;
  /** é”™è¯¯ä¸¥é‡ç¨‹åº¦ */
  severity?: ErrorSeverity | 'low' | 'medium' | 'high' | 'critical';
  /** é”™è¯¯æ¶ˆæ¯ */
  message?: string;
  /** æ˜¯å¦æ˜¾ç¤ºé”™è¯¯ */
  visible?: boolean;
  /** æ˜¯å¦å¯å…³é—­ */
  dismissible?: boolean;
  /** æ˜¯å¦æ˜¾ç¤ºé‡è¯•æŒ‰é’® */
  showRetry?: boolean;
  /** æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ */
  showDetails?: boolean;
  /** è¯¦ç»†é”™è¯¯ä¿¡æ¯ */
  details?: string;
  /** è‡ªåŠ¨æ¶ˆå¤±æ—¶é—´ (ms) */
  autoHide?: number;
  /** è‡ªå®šä¹‰CSSç±» */
  className?: string;
  /** é”™è¯¯å›¾æ ‡ */
  icon?: string;
}

const {
  type = 'UNKNOWN_ERROR',
  severity = 'medium',
  message = 'æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•',
  visible = true,
  dismissible = true,
  showRetry = false,
  showDetails = false,
  details = '',
  autoHide = 0,
  className = '',
  icon
} = Astro.props;

// å¦‚æœä¸æ˜¾ç¤ºï¼Œç›´æ¥è¿”å›
if (!visible) {
  return null;
}

// æ ¹æ®é”™è¯¯ç±»å‹å’Œä¸¥é‡ç¨‹åº¦ç¡®å®šæ ·å¼
const getSeverityClass = (sev: string) => {
  switch (sev.toLowerCase()) {
    case 'critical': return 'error-critical';
    case 'high': return 'error-high';
    case 'medium': return 'error-medium';
    case 'low': return 'error-low';
    default: return 'error-medium';
  }
};

const getErrorIcon = (errorType: string, errorIcon?: string) => {
  if (errorIcon) return errorIcon;
  
  switch (errorType) {
    case 'NETWORK_ERROR': return 'ğŸŒ';
    case 'TIMEOUT_ERROR': return 'â°';
    case 'DATA_ERROR': return 'ğŸ“Š';
    case 'CACHE_ERROR': return 'ğŸ’¾';
    case 'PARSE_ERROR': return 'ğŸ”§';
    case 'CONFIG_ERROR': return 'âš™ï¸';
    case 'PRELOAD_ERROR': return 'ğŸ”®';
    case 'STORAGE_ERROR': return 'ğŸ’¿';
    default: return 'âš ï¸';
  }
};

const severityClass = getSeverityClass(severity);
const errorIcon = getErrorIcon(type, icon);
const combinedClass = ['error-message', severityClass, className].filter(Boolean).join(' ');
---

<div class={combinedClass} id="error-message" role="alert" aria-live="polite">
  <!-- é”™è¯¯å†…å®¹ -->
  <div class="error-content">
    <!-- é”™è¯¯å›¾æ ‡å’Œæ¶ˆæ¯ -->
    <div class="error-main">
      <span class="error-icon" aria-hidden="true">{errorIcon}</span>
      <div class="error-text">
        <div class="error-message-text">{message}</div>
        {type !== 'UNKNOWN_ERROR' && (
          <div class="error-type">é”™è¯¯ç±»å‹: {type}</div>
        )}
      </div>
    </div>

    <!-- æ“ä½œæŒ‰é’® -->
    <div class="error-actions">
      {showRetry && (
        <button class="error-btn error-btn-retry" id="retry-btn" aria-label="é‡è¯•æ“ä½œ">
          ğŸ”„ é‡è¯•
        </button>
      )}
      
      {showDetails && details && (
        <button class="error-btn error-btn-details" id="details-btn" aria-label="æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯">
          ğŸ“‹ è¯¦æƒ…
        </button>
      )}
      
      {dismissible && (
        <button class="error-btn error-btn-close" id="close-btn" aria-label="å…³é—­é”™è¯¯æ¶ˆæ¯">
          âœ•
        </button>
      )}
    </div>
  </div>

  <!-- è¯¦ç»†ä¿¡æ¯é¢æ¿ -->
  {showDetails && details && (
    <div class="error-details" id="error-details" style="display: none;">
      <div class="error-details-title">è¯¦ç»†ä¿¡æ¯:</div>
      <div class="error-details-content">{details}</div>
    </div>
  )}
</div>

<style>
  /* åŸºç¡€æ ·å¼ */
  .error-message {
    position: relative;
    margin: 16px 0;
    padding: 16px;
    border-radius: 8px;
    border-left: 4px solid;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    animation: slideIn 0.3s ease-out;
  }

  /* ä¸¥é‡ç¨‹åº¦æ ·å¼ */
  .error-low {
    background: #f0f9ff;
    border-left-color: #0ea5e9;
    color: #0c4a6e;
  }

  .error-medium {
    background: #fffbeb;
    border-left-color: #f59e0b;
    color: #92400e;
  }

  .error-high {
    background: #fef2f2;
    border-left-color: #ef4444;
    color: #991b1b;
  }

  .error-critical {
    background: #fdf2f8;
    border-left-color: #ec4899;
    color: #831843;
    border: 2px solid #ec4899;
    box-shadow: 0 4px 12px rgba(236, 72, 153, 0.2);
  }

  /* å†…å®¹å¸ƒå±€ */
  .error-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 16px;
  }

  .error-main {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    flex: 1;
  }

  .error-icon {
    font-size: 20px;
    flex-shrink: 0;
    margin-top: 2px;
  }

  .error-text {
    flex: 1;
  }

  .error-message-text {
    font-weight: 500;
    margin-bottom: 4px;
  }

  .error-type {
    font-size: 12px;
    opacity: 0.8;
    font-family: monospace;
  }

  /* æ“ä½œæŒ‰é’® */
  .error-actions {
    display: flex;
    gap: 8px;
    flex-shrink: 0;
  }

  .error-btn {
    padding: 6px 12px;
    border: 1px solid transparent;
    border-radius: 4px;
    background: rgba(255, 255, 255, 0.8);
    color: inherit;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
  }

  .error-btn:hover {
    background: rgba(255, 255, 255, 1);
    transform: translateY(-1px);
  }

  .error-btn:active {
    transform: translateY(0);
  }

  .error-btn-retry {
    border-color: currentColor;
    font-weight: 500;
  }

  .error-btn-retry:hover {
    background: currentColor;
    color: white;
  }

  .error-btn-details {
    border-color: rgba(0, 0, 0, 0.2);
  }

  .error-btn-close {
    border-color: rgba(0, 0, 0, 0.2);
    font-weight: bold;
    min-width: 32px;
    padding: 6px 8px;
  }

  .error-btn-close:hover {
    background: rgba(0, 0, 0, 0.1);
  }

  /* è¯¦ç»†ä¿¡æ¯é¢æ¿ */
  .error-details {
    margin-top: 16px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.05);
    border-radius: 4px;
    border: 1px solid rgba(0, 0, 0, 0.1);
  }

  .error-details-title {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 13px;
  }

  .error-details-content {
    font-family: monospace;
    font-size: 12px;
    white-space: pre-wrap;
    word-break: break-word;
    opacity: 0.8;
    max-height: 200px;
    overflow-y: auto;
  }

  /* åŠ¨ç”»æ•ˆæœ */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  .error-message.hiding {
    animation: slideOut 0.3s ease-out forwards;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .error-message {
      margin: 12px 0;
      padding: 12px;
      font-size: 13px;
    }

    .error-content {
      flex-direction: column;
      gap: 12px;
    }

    .error-actions {
      justify-content: flex-end;
    }

    .error-btn {
      padding: 8px 12px;
      font-size: 13px;
    }
  }

  /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
  @media (prefers-color-scheme: dark) {
    .error-low {
      background: #0c1929;
      color: #7dd3fc;
    }

    .error-medium {
      background: #1c1917;
      color: #fbbf24;
    }

    .error-high {
      background: #1f1415;
      color: #fca5a5;
    }

    .error-critical {
      background: #1e1b26;
      color: #f9a8d4;
    }

    .error-btn {
      background: rgba(255, 255, 255, 0.1);
    }

    .error-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .error-details {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }
  }

  /* æ— éšœç¢æ”¯æŒ */
  @media (prefers-reduced-motion: reduce) {
    .error-message {
      animation: none;
    }

    .error-btn {
      transition: none;
    }

    .error-btn:hover {
      transform: none;
    }
  }

  /* æ‰“å°æ ·å¼ */
  @media print {
    .error-message {
      box-shadow: none;
      border: 1px solid #ccc;
    }

    .error-btn {
      display: none;
    }
  }
</style>

<script define:vars={{ autoHide, showDetails }}>
  console.log('ğŸš¨ ErrorMessageç»„ä»¶å·²åŠ è½½');

  // DOMå…ƒç´ 
  const errorMessage = document.getElementById('error-message');
  const retryBtn = document.getElementById('retry-btn');
  const detailsBtn = document.getElementById('details-btn');
  const closeBtn = document.getElementById('close-btn');
  const errorDetails = document.getElementById('error-details');

  // åˆå§‹åŒ–
  function initialize() {
    // ç»‘å®šäº‹ä»¶
    if (retryBtn) {
      retryBtn.addEventListener('click', handleRetry);
    }

    if (detailsBtn) {
      detailsBtn.addEventListener('click', toggleDetails);
    }

    if (closeBtn) {
      closeBtn.addEventListener('click', handleClose);
    }

    // è‡ªåŠ¨éšè—
    if (autoHide > 0) {
      setTimeout(() => {
        handleClose();
      }, autoHide);
    }
  }

  // å¤„ç†é‡è¯•
  function handleRetry() {
    console.log('ğŸ”„ ç”¨æˆ·ç‚¹å‡»é‡è¯•');
    
    // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
    if (errorMessage) {
      errorMessage.dispatchEvent(new CustomEvent('error-retry', {
        bubbles: true,
        detail: { timestamp: Date.now() }
      }));
    }
  }

  // åˆ‡æ¢è¯¦ç»†ä¿¡æ¯
  function toggleDetails() {
    if (errorDetails) {
      const isVisible = errorDetails.style.display !== 'none';
      errorDetails.style.display = isVisible ? 'none' : 'block';
      
      if (detailsBtn) {
        detailsBtn.textContent = isVisible ? 'ğŸ“‹ è¯¦æƒ…' : 'ğŸ“‹ éšè—';
      }
    }
  }

  // å¤„ç†å…³é—­
  function handleClose() {
    if (errorMessage) {
      errorMessage.classList.add('hiding');
      
      setTimeout(() => {
        errorMessage.style.display = 'none';
        
        // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
        errorMessage.dispatchEvent(new CustomEvent('error-dismissed', {
          bubbles: true,
          detail: { timestamp: Date.now() }
        }));
      }, 300);
    }
  }

  // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
  function showError() {
    if (errorMessage) {
      errorMessage.style.display = 'block';
      errorMessage.classList.remove('hiding');
    }
  }

  // éšè—é”™è¯¯æ¶ˆæ¯
  function hideError() {
    handleClose();
  }

  // æ›´æ–°é”™è¯¯æ¶ˆæ¯
  function updateError(newMessage, newType, newSeverity) {
    const messageText = errorMessage?.querySelector('.error-message-text');
    const typeText = errorMessage?.querySelector('.error-type');
    
    if (messageText) {
      messageText.textContent = newMessage;
    }
    
    if (typeText && newType) {
      typeText.textContent = `é”™è¯¯ç±»å‹: ${newType}`;
    }
    
    // æ›´æ–°æ ·å¼ç±»
    if (errorMessage && newSeverity) {
      errorMessage.className = errorMessage.className.replace(
        /error-(low|medium|high|critical)/,
        `error-${newSeverity.toLowerCase()}`
      );
    }
  }

  // ä½¿å‡½æ•°å…¨å±€å¯ç”¨
  window.ErrorMessage = {
    show: showError,
    hide: hideError,
    update: updateError,
    retry: handleRetry,
    toggleDetails: toggleDetails
  };

  // åˆå§‹åŒ–ç»„ä»¶
  initialize();
</script>

---
import Layout from '../layouts/Layout.astro';
---

<Layout title="é…ç½®è½¬æ¢å·¥å…·æµ‹è¯•" description="æµ‹è¯•ä¼ ç»Ÿé…ç½®åˆ°ä¼˜åŒ–é…ç½®çš„è½¬æ¢åŠŸèƒ½">
  <div class="converter-container">
    <div class="converter-header">
      <h1>ğŸ”„ é…ç½®è½¬æ¢å·¥å…·</h1>
      <p>å°†ä¼ ç»Ÿé…ç½®æ ¼å¼è½¬æ¢ä¸ºä¼˜åŒ–æ ¼å¼ï¼Œå¹¶ç”Ÿæˆå®Œæ•´çš„åˆ†ç±»æ–‡ä»¶</p>
    </div>

    <div class="converter-controls">
      <div class="input-section">
        <h3>ğŸ“¥ è¾“å…¥é…ç½®</h3>
        <div class="input-group">
          <label for="inputPath">ä¼ ç»Ÿé…ç½®æ–‡ä»¶è·¯å¾„:</label>
          <select id="inputPath" class="path-select">
            <option value="/config.json">ä¼ ç»Ÿæ ¼å¼ (config.json)</option>
          </select>
        </div>
        
        <div class="options-group">
          <h4>è½¬æ¢é€‰é¡¹</h4>
          <div class="option-item">
            <label for="previewCount">é¢„è§ˆç½‘ç«™æ•°é‡:</label>
            <input type="number" id="previewCount" value="3" min="1" max="10">
          </div>
          <div class="option-item">
            <label for="chunkSizeLimit">åˆ†ç±»æ–‡ä»¶å¤§å°é™åˆ¶ (KB):</label>
            <input type="number" id="chunkSizeLimit" value="100" min="50" max="500">
          </div>
          <div class="option-item">
            <label for="enablePreload">å¯ç”¨æ™ºèƒ½é¢„åŠ è½½:</label>
            <input type="checkbox" id="enablePreload" checked>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button id="convertBtn" class="convert-btn primary">
          ğŸš€ å¼€å§‹è½¬æ¢
        </button>
        <button id="downloadBtn" class="convert-btn secondary" disabled>
          ğŸ“¥ ä¸‹è½½ä¼˜åŒ–é…ç½®
        </button>
        <button id="clearBtn" class="convert-btn">
          ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
        </button>
      </div>
    </div>

    <div class="converter-results">
      <div class="result-section">
        <h3>ğŸ“Š è½¬æ¢ç»“æœ</h3>
        <div id="conversionResult" class="result-content">
          <p class="placeholder">ç‚¹å‡»"å¼€å§‹è½¬æ¢"æŸ¥çœ‹ç»“æœ...</p>
        </div>
      </div>

      <div class="result-section">
        <h3>ğŸ“‹ è½¬æ¢æŠ¥å‘Š</h3>
        <div id="conversionReport" class="result-content">
          <p class="placeholder">ç­‰å¾…è½¬æ¢æŠ¥å‘Š...</p>
        </div>
      </div>

      <div class="result-section">
        <h3>ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶</h3>
        <div id="generatedFiles" class="result-content">
          <p class="placeholder">ç­‰å¾…æ–‡ä»¶ç”Ÿæˆ...</p>
        </div>
      </div>

      <div class="result-section">
        <h3>ğŸ” é…ç½®é¢„è§ˆ</h3>
        <div id="configPreview" class="result-content">
          <p class="placeholder">ç­‰å¾…é…ç½®é¢„è§ˆ...</p>
        </div>
      </div>
    </div>

    <div class="converter-info">
      <h3>â„¹ï¸ è½¬æ¢è¯´æ˜</h3>
      <div class="info-grid">
        <div class="info-item">
          <h4>ğŸ¯ è½¬æ¢ç›®æ ‡</h4>
          <ul>
            <li>å°†ä¼ ç»Ÿå•æ–‡ä»¶é…ç½®æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶</li>
            <li>ç”ŸæˆåŸºç¡€é…ç½®æ–‡ä»¶ (config.json)</li>
            <li>ç”Ÿæˆåˆ†ç±»æ•°æ®æ–‡ä»¶ (categories/*.json)</li>
            <li>ä¼˜åŒ–é¦–æ¬¡åŠ è½½æ€§èƒ½</li>
          </ul>
        </div>
        <div class="info-item">
          <h4>ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–</h4>
          <ul>
            <li>å‡å°‘é¦–æ¬¡åŠ è½½æ•°æ®é‡ 60-80%</li>
            <li>æ”¯æŒæŒ‰éœ€åŠ è½½åˆ†ç±»æ•°æ®</li>
            <li>æä¾›é¢„è§ˆæ•°æ®å¿«é€Ÿå±•ç¤º</li>
            <li>æ”¯æŒç¼“å­˜å’Œé¢„åŠ è½½ç­–ç•¥</li>
          </ul>
        </div>
        <div class="info-item">
          <h4>ğŸ“ æ–‡ä»¶ç»“æ„</h4>
          <ul>
            <li>config.json - åŸºç¡€é…ç½®å’Œé¢„è§ˆæ•°æ®</li>
            <li>categories/0.json - ç¬¬1ä¸ªåˆ†ç±»æ•°æ®</li>
            <li>categories/1.json - ç¬¬2ä¸ªåˆ†ç±»æ•°æ®</li>
            <li>... æ›´å¤šåˆ†ç±»æ–‡ä»¶</li>
          </ul>
        </div>
        <div class="info-item">
          <h4>ğŸš€ éƒ¨ç½²æ–¹å¼</h4>
          <ul>
            <li>å°†config.jsonæ”¾åˆ°public/ç›®å½•</li>
            <li>å°†categories/æ–‡ä»¶å¤¹æ”¾åˆ°public/ç›®å½•</li>
            <li>ç¡®ä¿å‰ç«¯æ”¯æŒæ‡’åŠ è½½åŠŸèƒ½</li>
            <li>é…ç½®CDNåŠ é€Ÿè®¿é—®</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
  import { ConfigConverter, convertConfigFile, generateReport } from '../utils/ConfigConverter';
  import JSZip from 'jszip';

  // è·å–DOMå…ƒç´ 
  const inputPath = document.getElementById('inputPath') as HTMLSelectElement;
  const previewCount = document.getElementById('previewCount') as HTMLInputElement;
  const chunkSizeLimit = document.getElementById('chunkSizeLimit') as HTMLInputElement;
  const enablePreload = document.getElementById('enablePreload') as HTMLInputElement;

  const convertBtn = document.getElementById('convertBtn') as HTMLButtonElement;
  const downloadBtn = document.getElementById('downloadBtn') as HTMLButtonElement;
  const clearBtn = document.getElementById('clearBtn') as HTMLButtonElement;

  const conversionResult = document.getElementById('conversionResult') as HTMLElement;
  const conversionReport = document.getElementById('conversionReport') as HTMLElement;
  const generatedFiles = document.getElementById('generatedFiles') as HTMLElement;
  const configPreview = document.getElementById('configPreview') as HTMLElement;

  let convertedResult: any = null;

  // è½¬æ¢é…ç½®
  convertBtn.addEventListener('click', async () => {
    convertBtn.disabled = true;
    convertBtn.textContent = 'â³ è½¬æ¢ä¸­...';
    
    try {
      const options = {
        previewCount: parseInt(previewCount.value) || 3,
        chunkSizeLimit: parseInt(chunkSizeLimit.value) || 100,
        enablePreload: enablePreload.checked
      };

      console.log('ğŸ”„ å¼€å§‹è½¬æ¢é…ç½®...', { inputPath: inputPath.value, options });
      
      const result = await convertConfigFile(inputPath.value, options);
      convertedResult = result;
      
      // æ˜¾ç¤ºè½¬æ¢ç»“æœ
      displayConversionResult(result);
      
      // æ˜¾ç¤ºè½¬æ¢æŠ¥å‘Š
      displayConversionReport(result);
      
      // æ˜¾ç¤ºç”Ÿæˆçš„æ–‡ä»¶
      displayGeneratedFiles(result);
      
      // æ˜¾ç¤ºé…ç½®é¢„è§ˆ
      displayConfigPreview(result);
      
      // å¯ç”¨ä¸‹è½½æŒ‰é’®
      downloadBtn.disabled = false;
      
    } catch (error) {
      conversionResult.innerHTML = `
        <div class="result-item error">
          <h4>âŒ è½¬æ¢å¤±è´¥</h4>
          <p class="error">${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}</p>
        </div>
      `;
    } finally {
      convertBtn.disabled = false;
      convertBtn.textContent = 'ğŸš€ å¼€å§‹è½¬æ¢';
    }
  });

  // ä¸‹è½½ä¼˜åŒ–é…ç½®
  downloadBtn.addEventListener('click', async () => {
    if (!convertedResult) return;
    
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'â³ ç”Ÿæˆä¸­...';
    
    try {
      const zip = new JSZip();
      
      // æ·»åŠ åŸºç¡€é…ç½®æ–‡ä»¶
      zip.file('config.json', JSON.stringify(convertedResult.baseConfig, null, 2));
      
      // æ·»åŠ åˆ†ç±»æ–‡ä»¶
      const categoriesFolder = zip.folder('categories');
      if (categoriesFolder) {
        convertedResult.categoryFiles.forEach((file: any) => {
          categoriesFolder.file(file.filename, JSON.stringify(file.content, null, 2));
        });
      }
      
      // æ·»åŠ è½¬æ¢æŠ¥å‘Š
      const report = generateReport(convertedResult);
      zip.file('CONVERSION_REPORT.md', report);
      
      // ç”Ÿæˆå¹¶ä¸‹è½½ZIPæ–‡ä»¶
      const zipBlob = await zip.generateAsync({ type: 'blob' });
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
      const filename = `optimized-config-${timestamp}.zip`;
      
      const url = URL.createObjectURL(zipBlob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'ğŸ“¥ ä¸‹è½½ä¼˜åŒ–é…ç½®';
    }
  });

  // æ¸…ç©ºç»“æœ
  clearBtn.addEventListener('click', () => {
    conversionResult.innerHTML = '<p class="placeholder">ç‚¹å‡»"å¼€å§‹è½¬æ¢"æŸ¥çœ‹ç»“æœ...</p>';
    conversionReport.innerHTML = '<p class="placeholder">ç­‰å¾…è½¬æ¢æŠ¥å‘Š...</p>';
    generatedFiles.innerHTML = '<p class="placeholder">ç­‰å¾…æ–‡ä»¶ç”Ÿæˆ...</p>';
    configPreview.innerHTML = '<p class="placeholder">ç­‰å¾…é…ç½®é¢„è§ˆ...</p>';
    downloadBtn.disabled = true;
    convertedResult = null;
  });

  function displayConversionResult(result: any) {
    const { optimization } = result;
    
    conversionResult.innerHTML = `
      <div class="result-item success">
        <h4>âœ… è½¬æ¢æˆåŠŸ</h4>
        <div class="stats-grid">
          <div class="stat-item">
            <span class="stat-label">æ€»åˆ†ç±»æ•°:</span>
            <span class="stat-value">${optimization.totalCategories}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">æ€»ç½‘ç«™æ•°:</span>
            <span class="stat-value">${optimization.totalSites}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">åŸå§‹å¤§å°:</span>
            <span class="stat-value">${optimization.originalSizeKB}KB</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">ä¼˜åŒ–åå¤§å°:</span>
            <span class="stat-value">${optimization.optimizedSizeKB}KB</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">å‹ç¼©æ¯”ä¾‹:</span>
            <span class="stat-value highlight">${optimization.compressionRatio}%</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">é¢„è§ˆæ•°é‡:</span>
            <span class="stat-value">${optimization.previewCount}</span>
          </div>
        </div>
      </div>
    `;
  }

  function displayConversionReport(result: any) {
    const report = generateReport(result);
    conversionReport.innerHTML = `
      <div class="result-item">
        <pre class="report-content">${report}</pre>
      </div>
    `;
  }

  function displayGeneratedFiles(result: any) {
    const { baseConfig, categoryFiles } = result;
    
    const baseConfigSize = Math.ceil(JSON.stringify(baseConfig).length / 1024);
    const totalCategorySize = categoryFiles.reduce((sum: number, file: any) => 
      sum + file.content.metadata.fileSizeKB, 0
    );
    
    generatedFiles.innerHTML = `
      <div class="result-item">
        <h4>ğŸ“ æ–‡ä»¶æ¸…å•</h4>
        <div class="file-list">
          <div class="file-item main-config">
            <span class="file-name">ğŸ“„ config.json</span>
            <span class="file-size">${baseConfigSize}KB</span>
            <span class="file-desc">åŸºç¡€é…ç½®å’Œé¢„è§ˆæ•°æ®</span>
          </div>
          <div class="file-group">
            <div class="file-group-header">
              <span class="folder-name">ğŸ“ categories/</span>
              <span class="folder-size">${totalCategorySize}KB</span>
            </div>
            ${categoryFiles.map((file: any) => `
              <div class="file-item category-file">
                <span class="file-name">ğŸ“„ ${file.filename}</span>
                <span class="file-size">${file.content.metadata.fileSizeKB}KB</span>
                <span class="file-desc">${file.content.categoryName} (${file.content.siteCount} ä¸ªç½‘ç«™)</span>
              </div>
            `).join('')}
          </div>
        </div>
      </div>
    `;
  }

  function displayConfigPreview(result: any) {
    const { baseConfig } = result;
    
    configPreview.innerHTML = `
      <div class="result-item">
        <h4>ğŸ” åŸºç¡€é…ç½®é¢„è§ˆ</h4>
        <div class="config-summary">
          <p><strong>ç½‘ç«™æ ‡é¢˜:</strong> ${baseConfig.site.title}</p>
          <p><strong>èœå•é¡¹æ•°:</strong> ${baseConfig.menuItems.length}</p>
          <p><strong>ä¼˜åŒ–çŠ¶æ€:</strong> ${baseConfig.optimization.enabled ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨'}</p>
        </div>
        <details class="config-details">
          <summary>æŸ¥çœ‹å®Œæ•´é…ç½® JSON</summary>
          <pre class="config-json">${JSON.stringify(baseConfig, null, 2)}</pre>
        </details>
      </div>
    `;
  }
</script>

<style>
  .converter-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .converter-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .converter-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .converter-controls {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .input-section h3 {
    margin-bottom: 1rem;
    color: #333;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }

  .input-group, .option-item {
    margin-bottom: 1rem;
  }

  .input-group label, .option-item label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #555;
  }

  .path-select, .option-item input {
    width: 100%;
    max-width: 400px;
    padding: 0.75rem;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 1rem;
  }

  .options-group {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid #e9ecef;
  }

  .options-group h4 {
    margin-bottom: 1rem;
    color: #333;
  }

  .option-item {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .option-item label {
    margin-bottom: 0;
    min-width: 200px;
  }

  .option-item input[type="number"] {
    max-width: 120px;
  }

  .option-item input[type="checkbox"] {
    width: auto;
  }

  .action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 2rem;
    flex-wrap: wrap;
  }

  .convert-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .convert-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .convert-btn.secondary {
    background: #28a745;
    color: white;
  }

  .convert-btn:not(.primary):not(.secondary) {
    background: #6c757d;
    color: white;
  }

  .convert-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .convert-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .converter-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .result-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .result-section h3 {
    margin-bottom: 1rem;
    color: #333;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }

  .result-content {
    min-height: 150px;
  }

  .result-item {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .result-item.success {
    background: #d4edda;
    border-left: 4px solid #28a745;
  }

  .result-item.error {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
  }

  .result-item:not(.success):not(.error) {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    text-align: center;
    padding: 0.5rem;
    background: rgba(255,255,255,0.7);
    border-radius: 6px;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
  }

  .stat-value.highlight {
    color: #28a745;
    font-size: 1.4rem;
  }

  .report-content {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    font-size: 0.9rem;
    line-height: 1.5;
    overflow-x: auto;
  }

  .file-list {
    space-y: 0.5rem;
  }

  .file-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 0.5rem;
  }

  .file-item.main-config {
    background: #e3f2fd;
    border-left: 3px solid #2196f3;
  }

  .file-item.category-file {
    margin-left: 1rem;
    background: #f0f8f0;
    border-left: 3px solid #28a745;
  }

  .file-group-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.5rem;
    background: #fff3cd;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    border-left: 3px solid #ffc107;
  }

  .file-name, .folder-name {
    font-weight: 600;
    min-width: 120px;
  }

  .file-size, .folder-size {
    font-weight: bold;
    color: #666;
    min-width: 60px;
  }

  .file-desc {
    color: #666;
    font-size: 0.9rem;
  }

  .config-summary {
    margin-bottom: 1rem;
  }

  .config-summary p {
    margin-bottom: 0.5rem;
  }

  .config-details {
    margin-top: 1rem;
  }

  .config-details summary {
    cursor: pointer;
    font-weight: 600;
    color: #666;
    margin-bottom: 1rem;
  }

  .config-json {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 6px;
    font-size: 0.8rem;
    line-height: 1.4;
    overflow-x: auto;
    max-height: 400px;
    overflow-y: auto;
  }

  .placeholder {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 2rem;
  }

  .error {
    color: #dc3545;
    font-weight: 600;
  }

  .converter-info {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 2rem;
    border-left: 4px solid #17a2b8;
  }

  .converter-info h3 {
    margin-bottom: 1.5rem;
    color: #333;
  }

  .info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .info-item {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .info-item h4 {
    margin-bottom: 1rem;
    color: #333;
    border-bottom: 1px solid #e9ecef;
    padding-bottom: 0.5rem;
  }

  .info-item ul {
    list-style: none;
    padding: 0;
  }

  .info-item li {
    margin-bottom: 0.5rem;
    padding-left: 1rem;
    position: relative;
  }

  .info-item li::before {
    content: "â€¢";
    color: #17a2b8;
    font-weight: bold;
    position: absolute;
    left: 0;
  }

  @media (max-width: 768px) {
    .converter-container {
      padding: 1rem;
    }
    
    .action-buttons {
      flex-direction: column;
      align-items: center;
    }
    
    .convert-btn {
      width: 100%;
      max-width: 300px;
    }
    
    .converter-results {
      grid-template-columns: 1fr;
    }
    
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .info-grid {
      grid-template-columns: 1fr;
    }
    
    .option-item {
      flex-direction: column;
      align-items: flex-start;
    }
    
    .option-item label {
      min-width: auto;
    }
  }
</style>

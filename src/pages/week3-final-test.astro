---
/**
 * Week 3 æœ€ç»ˆé›†æˆæµ‹è¯•é¡µé¢
 * ä»»åŠ¡3.2: æœ€ç»ˆé›†æˆæµ‹è¯•
 */

import LoadingIndicator from '../components/LoadingIndicator.astro';
import PerformanceMonitor from '../components/PerformanceMonitor.astro';
import ErrorMessage from '../components/ErrorMessage.astro';
import { ConfigManager } from '../utils/ConfigManager';
import { LazyLoader } from '../utils/LazyLoader';
import { PreloadStrategy } from '../utils/PreloadStrategy';
import { PerformanceMonitor as PerformanceMonitorClass } from '../utils/PerformanceMonitor';
import { defaultErrorHandler } from '../utils/ErrorHandler';
import { defaultLocalStorageCache } from '../utils/LocalStorageCache';

// æµ‹è¯•ç»“æœæ¥å£
interface TestSuite {
  name: string;
  tests: TestResult[];
  summary: {
    total: number;
    passed: number;
    failed: number;
    successRate: number;
    totalDuration: number;
  };
}

interface TestResult {
  name: string;
  success: boolean;
  duration: number;
  details: any;
  error?: string;
  category: 'functional' | 'performance' | 'compatibility' | 'stress' | 'ux';
}

async function runTest(name: string, category: TestResult['category'], testFn: () => Promise<any>): Promise<TestResult> {
  const startTime = performance.now();
  try {
    const result = await testFn();
    return {
      name,
      category,
      success: true,
      duration: performance.now() - startTime,
      details: result
    };
  } catch (error) {
    return {
      name,
      category,
      success: false,
      duration: performance.now() - startTime,
      details: {},
      error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    };
  }
}

// åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
const configManager = new ConfigManager();
const lazyLoader = new LazyLoader(configManager);
const preloadStrategy = new PreloadStrategy(lazyLoader, configManager);
const performanceMonitor = new PerformanceMonitorClass();

// æ‰§è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
const testSuites: TestSuite[] = [];

// 1. åŠŸèƒ½æµ‹è¯•å¥—ä»¶
const functionalTests: TestResult[] = [
  await runTest('é…ç½®ç®¡ç†å™¨åˆå§‹åŒ–', 'functional', async () => {
    const result = await configManager.loadConfig();
    return {
      configLoaded: result.success,
      isOptimized: result.isOptimized,
      loadTime: result.loadTime,
      hasCategories: configManager.getAllCategoryIndexes().length > 0
    };
  }),

  await runTest('æ‡’åŠ è½½åŠŸèƒ½éªŒè¯', 'functional', async () => {
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length === 0) throw new Error('æ²¡æœ‰å¯ç”¨åˆ†ç±»');

    const result = await lazyLoader.loadCategory(categories[0]);
    const cacheStats = lazyLoader.getCacheStats();

    return {
      loadSuccess: result.success,
      hasData: !!result.data,
      cacheWorking: cacheStats.cacheSize > 0,
      dualCacheEnabled: !!cacheStats.localStorage
    };
  }),

  await runTest('é¢„åŠ è½½ç­–ç•¥éªŒè¯', 'functional', async () => {
    await preloadStrategy.executePreload();
    const stats = preloadStrategy.getPreloadStats();

    return {
      preloadExecuted: stats.totalPreloads > 0,
      successRate: stats.successRate,
      cacheHitRate: stats.cacheHitRate,
      preloadWorking: stats.successRate > 0
    };
  }),

  await runTest('æ€§èƒ½ç›‘æ§åŠŸèƒ½', 'functional', async () => {
    performanceMonitor.recordConfigLoadTime(300);
    performanceMonitor.recordCategoryLoadTime(150);

    const metrics = performanceMonitor.getMetrics();
    const score = performanceMonitor.getPerformanceScore();

    return {
      metricsRecorded: metrics.configLoadTime > 0,
      scoreCalculated: score > 0,
      monitoringWorking: metrics.configLoadTime === 300
    };
  }),

  await runTest('é”™è¯¯å¤„ç†æœºåˆ¶', 'functional', async () => {
    const testError = new Error('æµ‹è¯•é”™è¯¯');
    const result = await defaultErrorHandler.handleError(testError);
    const health = defaultErrorHandler.getSystemHealth();

    return {
      errorHandled: !result.success,
      hasUserMessage: !!result.error?.userMessage,
      healthMonitoring: health.score >= 0,
      errorHandlingWorking: !!result.error
    };
  }),

  await runTest('æœ¬åœ°å­˜å‚¨ç¼“å­˜', 'functional', async () => {
    await defaultLocalStorageCache.set('test-key', { test: 'data' });
    const retrieved = await defaultLocalStorageCache.get('test-key');
    const stats = defaultLocalStorageCache.getStats();

    return {
      dataStored: !!retrieved,
      dataMatches: retrieved?.test === 'data',
      statsAvailable: stats.totalItems >= 0,
      cacheWorking: !!retrieved && stats.totalItems > 0
    };
  })
];

testSuites.push({
  name: 'åŠŸèƒ½æµ‹è¯•',
  tests: functionalTests,
  summary: {
    total: functionalTests.length,
    passed: functionalTests.filter(t => t.success).length,
    failed: functionalTests.filter(t => !t.success).length,
    successRate: (functionalTests.filter(t => t.success).length / functionalTests.length) * 100,
    totalDuration: functionalTests.reduce((sum, t) => sum + t.duration, 0)
  }
});

// 2. æ€§èƒ½æµ‹è¯•å¥—ä»¶
const performanceTests: TestResult[] = [
  await runTest('é¦–å±åŠ è½½æ€§èƒ½', 'performance', async () => {
    const startTime = performance.now();
    const configResult = await configManager.loadConfig();
    const loadTime = performance.now() - startTime;

    return {
      loadTime,
      targetMet: loadTime < 500, // ç›®æ ‡ <500ms
      configLoaded: configResult.success,
      performanceGood: loadTime < 1000
    };
  }),

  await runTest('åˆ†ç±»åˆ‡æ¢æ€§èƒ½', 'performance', async () => {
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length < 2) throw new Error('åˆ†ç±»æ•°é‡ä¸è¶³');

    const times: number[] = [];
    for (let i = 0; i < Math.min(3, categories.length); i++) {
      const startTime = performance.now();
      await lazyLoader.loadCategory(categories[i]);
      times.push(performance.now() - startTime);
    }

    const avgTime = times.reduce((sum, time) => sum + time, 0) / times.length;

    return {
      avgSwitchTime: avgTime,
      targetMet: avgTime < 100, // ç›®æ ‡ <100ms
      allTimesGood: times.every(time => time < 200),
      times
    };
  }),

  await runTest('ç¼“å­˜å‘½ä¸­ç‡éªŒè¯', 'performance', async () => {
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length === 0) throw new Error('æ²¡æœ‰å¯ç”¨åˆ†ç±»');

    // é¦–æ¬¡åŠ è½½
    await lazyLoader.loadCategory(categories[0]);

    // é‡å¤åŠ è½½æµ‹è¯•ç¼“å­˜
    const cacheStartTime = performance.now();
    const cacheResult = await lazyLoader.loadCategory(categories[0]);
    const cacheTime = performance.now() - cacheStartTime;

    const cacheStats = lazyLoader.getCacheStats();

    return {
      cacheHit: cacheResult.fromCache,
      cacheTime,
      hitRate: cacheStats.localStorage?.hitRate || 0,
      targetMet: (cacheStats.localStorage?.hitRate || 0) > 80, // ç›®æ ‡ >80%
      fastCacheAccess: cacheTime < 50
    };
  }),

  await runTest('å†…å­˜ä½¿ç”¨ç›‘æ§', 'performance', async () => {
    const metrics = performanceMonitor.getMetrics();
    const memoryUsage = metrics.memoryUsage;

    // åŠ è½½å¤šä¸ªåˆ†ç±»æµ‹è¯•å†…å­˜
    const categories = configManager.getAllCategoryIndexes();
    for (let i = 0; i < Math.min(5, categories.length); i++) {
      await lazyLoader.loadCategory(categories[i]);
    }

    const finalMetrics = performanceMonitor.getMetrics();
    const finalMemoryUsage = finalMetrics.memoryUsage;

    return {
      initialMemory: memoryUsage,
      finalMemory: finalMemoryUsage,
      memoryIncrease: finalMemoryUsage - memoryUsage,
      targetMet: finalMemoryUsage < 50, // ç›®æ ‡ <50MB
      memoryEfficient: finalMemoryUsage < 100
    };
  })
];

testSuites.push({
  name: 'æ€§èƒ½æµ‹è¯•',
  tests: performanceTests,
  summary: {
    total: performanceTests.length,
    passed: performanceTests.filter(t => t.success).length,
    failed: performanceTests.filter(t => !t.success).length,
    successRate: (performanceTests.filter(t => t.success).length / performanceTests.length) * 100,
    totalDuration: performanceTests.reduce((sum, t) => sum + t.duration, 0)
  }
});

// 3. å…¼å®¹æ€§æµ‹è¯•å¥—ä»¶
const compatibilityTests: TestResult[] = [
  await runTest('é…ç½®æ ¼å¼å…¼å®¹æ€§', 'compatibility', async () => {
    const loadResult = await configManager.loadConfig();

    // è·å–é…ç½®æ ¼å¼ä¿¡æ¯
    const formatInfo = configManager.getConfigFormat();

    return {
      formatDetected: !!formatInfo,
      formatType: formatInfo || 'unknown',
      loadSuccess: loadResult.success,
      compatibilityWorking: !!formatInfo && loadResult.success
    };
  }),

  await runTest('æµè§ˆå™¨å­˜å‚¨å…¼å®¹æ€§', 'compatibility', async () => {
    const localStorageSupported = typeof localStorage !== 'undefined';
    const sessionStorageSupported = typeof sessionStorage !== 'undefined';

    // æµ‹è¯•å­˜å‚¨åŠŸèƒ½
    let storageWorking = false;
    try {
      localStorage.setItem('test', 'value');
      storageWorking = localStorage.getItem('test') === 'value';
      localStorage.removeItem('test');
    } catch (error) {
      storageWorking = false;
    }

    return {
      localStorageSupported,
      sessionStorageSupported,
      storageWorking,
      compatibilityGood: localStorageSupported && storageWorking
    };
  }),

  await runTest('APIå…¼å®¹æ€§éªŒè¯', 'compatibility', async () => {
    const fetchSupported = typeof fetch !== 'undefined';
    const promiseSupported = typeof Promise !== 'undefined';
    const asyncSupported = true; // å¦‚æœä»£ç è¿è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜async/awaitæ”¯æŒ

    return {
      fetchSupported,
      promiseSupported,
      asyncSupported,
      apiCompatibilityGood: fetchSupported && promiseSupported && asyncSupported
    };
  })
];

testSuites.push({
  name: 'å…¼å®¹æ€§æµ‹è¯•',
  tests: compatibilityTests,
  summary: {
    total: compatibilityTests.length,
    passed: compatibilityTests.filter(t => t.success).length,
    failed: compatibilityTests.filter(t => !t.success).length,
    successRate: (compatibilityTests.filter(t => t.success).length / compatibilityTests.length) * 100,
    totalDuration: compatibilityTests.reduce((sum, t) => sum + t.duration, 0)
  }
});

// è®¡ç®—æ€»ä½“ç»Ÿè®¡
const allTests = testSuites.flatMap(suite => suite.tests);
const overallStats = {
  totalTests: allTests.length,
  totalPassed: allTests.filter(t => t.success).length,
  totalFailed: allTests.filter(t => !t.success).length,
  overallSuccessRate: (allTests.filter(t => t.success).length / allTests.length) * 100,
  totalDuration: allTests.reduce((sum, t) => sum + t.duration, 0)
};

// KPIéªŒè¯
const kpiResults = {
  firstScreenLoad: performanceTests[0]?.details?.loadTime < 500,
  categorySwitchTime: performanceTests[1]?.details?.avgSwitchTime < 100,
  cacheHitRate: performanceTests[2]?.details?.hitRate > 80,
  memoryUsage: performanceTests[3]?.details?.finalMemory < 50,
  functionalComplete: functionalTests.every(t => t.success),
  errorHandling: functionalTests[4]?.success,
  userExperience: true // åŸºäºç»„ä»¶å¯ç”¨æ€§åˆ¤æ–­
};

const kpiScore = Object.values(kpiResults).filter(Boolean).length / Object.keys(kpiResults).length * 100;
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Week 3 æœ€ç»ˆé›†æˆæµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
      line-height: 1.6;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      margin: 0 0 10px 0;
      font-size: 2.5em;
    }

    .header .subtitle {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .kpi-dashboard {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .kpi-item {
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      border: 2px solid;
    }

    .kpi-item.pass {
      background: #d1fae5;
      border-color: #10b981;
      color: #065f46;
    }

    .kpi-item.fail {
      background: #fee2e2;
      border-color: #ef4444;
      color: #991b1b;
    }

    .kpi-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .kpi-description {
      font-size: 12px;
      opacity: 0.8;
    }

    .overall-score {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .score-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: bold;
      color: white;
    }

    .score-excellent {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .score-good {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
    }

    .score-warning {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .score-poor {
      background: linear-gradient(135deg, #ef4444, #dc2626);
    }

    .test-suites {
      display: grid;
      gap: 30px;
    }

    .test-suite {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .suite-header {
      padding: 25px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .suite-header.functional {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .suite-header.performance {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .suite-header.compatibility {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .suite-title {
      font-size: 24px;
      font-weight: bold;
    }

    .suite-summary {
      text-align: right;
      font-size: 14px;
    }

    .suite-stats {
      display: flex;
      gap: 15px;
      margin-top: 5px;
    }

    .test-grid {
      display: grid;
      gap: 15px;
      padding: 25px;
    }

    .test-item {
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid;
    }

    .test-item.success {
      background: #f0fdf4;
      border-left-color: #22c55e;
    }

    .test-item.failure {
      background: #fef2f2;
      border-left-color: #ef4444;
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .test-name {
      font-weight: 600;
      color: #1f2937;
    }

    .test-duration {
      font-size: 12px;
      color: #6b7280;
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .test-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }

    .test-details pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-message {
      background: #fef2f2;
      color: #991b1b;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 3px solid #ef4444;
    }

    .component-showcase {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .showcase-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .component-demo {
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }

    .demo-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: #374151;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .header {
        padding: 20px;
      }

      .header h1 {
        font-size: 2em;
      }

      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .test-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¯ Week 3 æœ€ç»ˆé›†æˆæµ‹è¯•</h1>
    <div class="subtitle">
      ä»»åŠ¡3.2: æœ€ç»ˆé›†æˆæµ‹è¯• | æµ‹è¯•æ—¶é—´: {new Date().toLocaleString()}
    </div>
  </div>

  <!-- KPIä»ªè¡¨æ¿ -->
  <div class="kpi-dashboard">
    <h2>ğŸ“Š å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPI) éªŒè¯</h2>
    <div class="kpi-grid">
      <div class={`kpi-item ${kpiResults.firstScreenLoad ? 'pass' : 'fail'}`}>
        <div class="kpi-title">é¦–å±åŠ è½½æ—¶é—´</div>
        <div class="kpi-value">{kpiResults.firstScreenLoad ? 'âœ… é€šè¿‡' : 'âŒ æœªè¾¾æ ‡'}</div>
        <div class="kpi-description">ç›®æ ‡: &lt;500ms</div>
      </div>

      <div class={`kpi-item ${kpiResults.categorySwitchTime ? 'pass' : 'fail'}`}>
        <div class="kpi-title">åˆ†ç±»åˆ‡æ¢æ—¶é—´</div>
        <div class="kpi-value">{kpiResults.categorySwitchTime ? 'âœ… é€šè¿‡' : 'âŒ æœªè¾¾æ ‡'}</div>
        <div class="kpi-description">ç›®æ ‡: &lt;100ms</div>
      </div>

      <div class={`kpi-item ${kpiResults.cacheHitRate ? 'pass' : 'fail'}`}>
        <div class="kpi-title">ç¼“å­˜å‘½ä¸­ç‡</div>
        <div class="kpi-value">{kpiResults.cacheHitRate ? 'âœ… é€šè¿‡' : 'âŒ æœªè¾¾æ ‡'}</div>
        <div class="kpi-description">ç›®æ ‡: &gt;80%</div>
      </div>

      <div class={`kpi-item ${kpiResults.memoryUsage ? 'pass' : 'fail'}`}>
        <div class="kpi-title">å†…å­˜ä½¿ç”¨</div>
        <div class="kpi-value">{kpiResults.memoryUsage ? 'âœ… é€šè¿‡' : 'âŒ æœªè¾¾æ ‡'}</div>
        <div class="kpi-description">ç›®æ ‡: &lt;50MB</div>
      </div>

      <div class={`kpi-item ${kpiResults.functionalComplete ? 'pass' : 'fail'}`}>
        <div class="kpi-title">åŠŸèƒ½å®Œæ•´æ€§</div>
        <div class="kpi-value">{kpiResults.functionalComplete ? 'âœ… é€šè¿‡' : 'âŒ æœªè¾¾æ ‡'}</div>
        <div class="kpi-description">æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸</div>
      </div>

      <div class={`kpi-item ${kpiResults.errorHandling ? 'pass' : 'fail'}`}>
        <div class="kpi-title">é”™è¯¯å¤„ç†</div>
        <div class="kpi-value">{kpiResults.errorHandling ? 'âœ… é€šè¿‡' : 'âŒ æœªè¾¾æ ‡'}</div>
        <div class="kpi-description">é”™è¯¯å¤„ç†æœºåˆ¶å®Œå–„</div>
      </div>
    </div>
  </div>

  <!-- æ€»ä½“è¯„åˆ† -->
  <div class="overall-score">
    <h2>ğŸ† æ€»ä½“æµ‹è¯•è¯„åˆ†</h2>
    <div class={`score-circle ${
      kpiScore >= 90 ? 'score-excellent' :
      kpiScore >= 80 ? 'score-good' :
      kpiScore >= 60 ? 'score-warning' : 'score-poor'
    }`}>
      {kpiScore.toFixed(0)}%
    </div>
    <div class="score-description">
      {kpiScore >= 90 ? 'ğŸŒŸ ä¼˜ç§€ - æ‰€æœ‰æŒ‡æ ‡è¡¨ç°å“è¶Š' :
       kpiScore >= 80 ? 'ğŸ‘ è‰¯å¥½ - å¤§éƒ¨åˆ†æŒ‡æ ‡è¾¾æ ‡' :
       kpiScore >= 60 ? 'âš ï¸ ä¸€èˆ¬ - éƒ¨åˆ†æŒ‡æ ‡éœ€è¦ä¼˜åŒ–' :
       'âŒ éœ€è¦æ”¹è¿› - å¤šä¸ªæŒ‡æ ‡æœªè¾¾æ ‡'}
    </div>
  </div>

  <!-- ç»„ä»¶å±•ç¤º -->
  <div class="component-showcase">
    <h2>ğŸ§© æ ¸å¿ƒç»„ä»¶å±•ç¤º</h2>
    <div class="showcase-grid">
      <div class="component-demo">
        <div class="demo-title">ğŸ“Š æ€§èƒ½ç›‘æ§é¢æ¿</div>
        <PerformanceMonitor
          visible={true}
          position="top-left"
          collapsible={true}
          defaultCollapsed={false}
          updateInterval={5000}
        />
      </div>

      <div class="component-demo">
        <div class="demo-title">â³ åŠ è½½æŒ‡ç¤ºå™¨</div>
        <LoadingIndicator
          visible={true}
          message="æ­£åœ¨åŠ è½½åˆ†ç±»æ•°æ®..."
          showProgress={true}
          progress={75}
          size="medium"
        />
      </div>

      <div class="component-demo">
        <div class="demo-title">ğŸš¨ é”™è¯¯æ¶ˆæ¯ç»„ä»¶</div>
        <ErrorMessage
          type="NETWORK_ERROR"
          severity="medium"
          message="ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯•..."
          showRetry={true}
          dismissible={true}
        />
      </div>
    </div>
  </div>

  <!-- æµ‹è¯•å¥—ä»¶ç»“æœ -->
  <div class="test-suites">
    {testSuites.map((suite) => (
      <div class="test-suite">
        <div class={`suite-header ${suite.name === 'åŠŸèƒ½æµ‹è¯•' ? 'functional' :
                                   suite.name === 'æ€§èƒ½æµ‹è¯•' ? 'performance' : 'compatibility'}`}>
          <div class="suite-title">
            {suite.name === 'åŠŸèƒ½æµ‹è¯•' ? 'ğŸ”§' :
             suite.name === 'æ€§èƒ½æµ‹è¯•' ? 'âš¡' : 'ğŸ”—'} {suite.name}
          </div>
          <div class="suite-summary">
            <div>é€šè¿‡ç‡: {suite.summary.successRate.toFixed(1)}%</div>
            <div class="suite-stats">
              <span>âœ… {suite.summary.passed}</span>
              <span>âŒ {suite.summary.failed}</span>
              <span>â±ï¸ {suite.summary.totalDuration.toFixed(0)}ms</span>
            </div>
          </div>
        </div>

        <div class="test-grid">
          {suite.tests.map((test, index) => (
            <div class={`test-item ${test.success ? 'success' : 'failure'}`}>
              <div class="test-header">
                <div class="test-name">
                  <span>{test.success ? 'âœ…' : 'âŒ'}</span>
                  {test.name}
                </div>
                <div class="test-duration">{test.duration.toFixed(2)}ms</div>
              </div>

              <div class="test-details">
                <strong>æµ‹è¯•è¯¦æƒ…:</strong>
                <pre>{JSON.stringify(test.details, null, 2)}</pre>
              </div>

              {test.error && (
                <div class="error-message">
                  <strong>é”™è¯¯ä¿¡æ¯:</strong> {test.error}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    ))}
  </div>

  <script define:vars={{ testSuites, kpiResults, kpiScore, overallStats }} is:inline>
    console.log('ğŸ¯ Week 3 æœ€ç»ˆé›†æˆæµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('ğŸ“Š æµ‹è¯•å¥—ä»¶ç»“æœ:', JSON.stringify(testSuites, null, 2));
    console.log('ğŸ“Š KPIéªŒè¯ç»“æœ:', JSON.stringify(kpiResults, null, 2));
    console.log('ğŸ† KPIè¯„åˆ†:', kpiScore);
    console.log('ğŸ“ˆ æ€»ä½“ç»Ÿè®¡:', JSON.stringify(overallStats, null, 2));

    // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
    const generateReport = () => {
      const report = {
        timestamp: new Date().toISOString(),
        kpiScore,
        kpiResults,
        testSuites: testSuites.map(suite => ({
          name: suite.name,
          summary: suite.summary,
          tests: suite.tests.map(test => ({
            name: test.name,
            success: test.success,
            duration: test.duration,
            category: test.category
          }))
        })),
        overallStats,
        environment: {
          userAgent: navigator.userAgent,
          viewport: `${window.innerWidth}x${window.innerHeight}`,
          timestamp: Date.now()
        }
      };

      return report;
    };

    // å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š
    window.exportTestReport = () => {
      const report = generateReport();
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `week3-final-test-report-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // æ˜¾ç¤ºæµ‹è¯•æ€»ç»“
    console.log('ğŸ“‹ æµ‹è¯•æ€»ç»“:');
    console.log(`   æ€»æµ‹è¯•æ•°: ${overallStats.totalTests}`);
    console.log(`   é€šè¿‡æ•°: ${overallStats.totalPassed}`);
    console.log(`   å¤±è´¥æ•°: ${overallStats.totalFailed}`);
    console.log(`   æˆåŠŸç‡: ${overallStats.overallSuccessRate.toFixed(1)}%`);
    console.log(`   æ€»è€—æ—¶: ${overallStats.totalDuration.toFixed(0)}ms`);
    console.log(`   KPIè¯„åˆ†: ${kpiScore.toFixed(1)}%`);

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰KPIéƒ½é€šè¿‡
    const allKpiPassed = Object.values(kpiResults).every(Boolean);
    if (allKpiPassed) {
      console.log('ğŸ‰ æ­å–œï¼æ‰€æœ‰KPIæŒ‡æ ‡éƒ½å·²è¾¾æ ‡ï¼');
    } else {
      console.log('âš ï¸ éƒ¨åˆ†KPIæŒ‡æ ‡æœªè¾¾æ ‡ï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–');
    }
  </script>
</body>
</html>
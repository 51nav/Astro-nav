---
import Layout from '../layouts/Layout.astro';
---

<Layout title="é…ç½®ç”Ÿæˆå™¨ - æ€§èƒ½ä¼˜åŒ–ç‰ˆ">
  <div class="generator-container">
    <header class="generator-header">
      <h1>ğŸš€ é…ç½®ç”Ÿæˆå™¨</h1>
      <p>é€šè¿‡è¡¨æ ¼æ•°æ®ç”Ÿæˆå¯¼èˆªç½‘ç«™é…ç½®æ–‡ä»¶ï¼Œæ”¯æŒæ€§èƒ½ä¼˜åŒ–</p>
    </header>

    <div class="generator-content">
      <form id="configForm" class="config-form" enctype="multipart/form-data">
        <!-- ç½‘ç«™åŸºæœ¬ä¿¡æ¯ -->
        <section class="form-section">
          <h2>ğŸ“ ç½‘ç«™åŸºæœ¬ä¿¡æ¯</h2>
          <div class="form-group">
            <label for="siteTitle">ç½‘ç«™æ ‡é¢˜</label>
            <input type="text" id="siteTitle" name="siteTitle" value="æˆ‘çš„å¯¼èˆªç½‘ç«™" required>
          </div>
          <div class="form-group">
            <label for="siteDescription">ç½‘ç«™æè¿°</label>
            <input type="text" id="siteDescription" name="siteDescription" value="ä¸“ä¸šçš„å¯¼èˆªå¹³å°" required>
          </div>
          <div class="form-group">
            <label for="logoText">Logoæ–‡å­—</label>
            <input type="text" id="logoText" name="logoText" value="MyNav" required>
          </div>
        </section>

        <!-- æ–‡ä»¶ä¸Šä¼  -->
        <section class="form-section">
          <h2>ğŸ“Š è¡¨æ ¼æ–‡ä»¶ä¸Šä¼ </h2>
          <div class="form-group">
            <label for="menuFile">èœå•è¡¨æ ¼æ–‡ä»¶</label>
            <input type="file" id="menuFile" name="menuFile" accept=".csv,.xlsx" required>
            <small>æ”¯æŒ CSV å’Œ Excel æ ¼å¼ï¼ŒåŒ…å«èœå•ç»“æ„æ•°æ®</small>
          </div>
          <div class="form-group">
            <label for="siteFile">ç½‘ç«™è¡¨æ ¼æ–‡ä»¶</label>
            <input type="file" id="siteFile" name="siteFile" accept=".csv,.xlsx" required>
            <small>æ”¯æŒ CSV å’Œ Excel æ ¼å¼ï¼ŒåŒ…å«ç½‘ç«™è¯¦ç»†æ•°æ®</small>
          </div>
        </section>

        <!-- æ€§èƒ½ä¼˜åŒ–é€‰é¡¹ -->
        <section class="form-section">
          <h2>âš¡ æ€§èƒ½ä¼˜åŒ–é€‰é¡¹</h2>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" id="optimizationEnabled" name="optimizationEnabled" checked>
              <span class="checkmark"></span>
              å¯ç”¨æ€§èƒ½ä¼˜åŒ–
            </label>
            <small>å°†é…ç½®æ–‡ä»¶æ‹†åˆ†ä¸ºå¤šä¸ªå°æ–‡ä»¶ï¼Œæå‡åŠ è½½æ€§èƒ½</small>
          </div>
          
          <div id="optimizationOptions" class="optimization-options">
            <div class="form-group">
              <label for="previewCount">é¢„è§ˆç½‘ç«™æ•°é‡</label>
              <input type="number" id="previewCount" name="previewCount" value="3" min="1" max="10">
              <small>æ¯ä¸ªåˆ†ç±»æ˜¾ç¤ºçš„é¢„è§ˆç½‘ç«™æ•°é‡</small>
            </div>
            <div class="form-group">
              <label for="chunkSizeLimit">åˆ†ç±»æ–‡ä»¶å¤§å°é™åˆ¶ (KB)</label>
              <input type="number" id="chunkSizeLimit" name="chunkSizeLimit" value="100" min="50" max="500">
              <small>å•ä¸ªåˆ†ç±»æ–‡ä»¶çš„æœ€å¤§å¤§å°</small>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="enablePreload" name="enablePreload" checked>
                <span class="checkmark"></span>
                å¯ç”¨æ™ºèƒ½é¢„åŠ è½½
              </label>
              <small>è‡ªåŠ¨é¢„åŠ è½½çƒ­é—¨åˆ†ç±»ï¼Œæå‡ç”¨æˆ·ä½“éªŒ</small>
            </div>
          </div>
        </section>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <section class="form-section">
          <button type="submit" class="generate-btn" id="generateBtn">
            <span class="btn-text">ğŸš€ ç”Ÿæˆé…ç½®æ–‡ä»¶</span>
            <span class="btn-loading" style="display: none;">â³ ç”Ÿæˆä¸­...</span>
          </button>
        </section>
      </form>

      <!-- ç»“æœæ˜¾ç¤º -->
      <div id="resultSection" class="result-section" style="display: none;">
        <h2>âœ… ç”Ÿæˆå®Œæˆ</h2>
        <div id="resultContent" class="result-content">
          <!-- åŠ¨æ€å†…å®¹ -->
        </div>
      </div>

      <!-- é”™è¯¯æ˜¾ç¤º -->
      <div id="errorSection" class="error-section" style="display: none;">
        <h2>âŒ ç”Ÿæˆå¤±è´¥</h2>
        <div id="errorContent" class="error-content">
          <!-- åŠ¨æ€å†…å®¹ -->
        </div>
      </div>
    </div>

    <!-- æ¨¡æ¿ä¸‹è½½ -->
    <section class="template-section">
      <h2>ğŸ“‹ æ¨¡æ¿æ–‡ä»¶ä¸‹è½½</h2>
      <p>å¦‚æœæ‚¨è¿˜æ²¡æœ‰å‡†å¤‡è¡¨æ ¼æ•°æ®ï¼Œå¯ä»¥ä¸‹è½½æ¨¡æ¿æ–‡ä»¶ï¼š</p>
      <div class="template-links">
        <a href="/templates/menu-template.csv" download class="template-link">
          ğŸ“Š èœå•æ¨¡æ¿ (CSV)
        </a>
        <a href="/templates/site-template.csv" download class="template-link">
          ğŸŒ ç½‘ç«™æ¨¡æ¿ (CSV)
        </a>
      </div>
    </section>
  </div>
</Layout>

<script>
  // è¡¨å•å¤„ç†é€»è¾‘
  const form = document.getElementById('configForm') as HTMLFormElement;
  const generateBtn = document.getElementById('generateBtn') as HTMLButtonElement;
  const btnText = generateBtn.querySelector('.btn-text') as HTMLElement;
  const btnLoading = generateBtn.querySelector('.btn-loading') as HTMLElement;
  const resultSection = document.getElementById('resultSection') as HTMLElement;
  const errorSection = document.getElementById('errorSection') as HTMLElement;
  const optimizationEnabled = document.getElementById('optimizationEnabled') as HTMLInputElement;
  const optimizationOptions = document.getElementById('optimizationOptions') as HTMLElement;

  // ä¼˜åŒ–é€‰é¡¹æ˜¾ç¤º/éšè—
  optimizationEnabled.addEventListener('change', () => {
    optimizationOptions.style.display = optimizationEnabled.checked ? 'block' : 'none';
  });

  // è¡¨å•æäº¤å¤„ç†
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    generateBtn.disabled = true;
    btnText.style.display = 'none';
    btnLoading.style.display = 'inline';
    resultSection.style.display = 'none';
    errorSection.style.display = 'none';

    try {
      const formData = new FormData(form);
      
      const response = await fetch('/api/generate-optimized-config', {
        method: 'POST',
        body: formData
      });

      if (response.ok) {
        // è·å–é…ç½®ä¿¡æ¯
        const configInfo = response.headers.get('X-Config-Info');
        let info = null;
        if (configInfo) {
          try {
            info = JSON.parse(configInfo);
          } catch (e) {
            console.warn('Failed to parse config info:', e);
          }
        }

        // ä¸‹è½½æ–‡ä»¶
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = info?.data?.filename || 'config.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);

        // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
        showResult(info);
      } else {
        const errorData = await response.json();
        showError(errorData.error || 'ç”Ÿæˆå¤±è´¥');
      }
    } catch (error) {
      console.error('ç”Ÿæˆé…ç½®æ—¶å‡ºé”™:', error);
      showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
    } finally {
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      generateBtn.disabled = false;
      btnText.style.display = 'inline';
      btnLoading.style.display = 'none';
    }
  });

  function showResult(info: any) {
    const resultContent = document.getElementById('resultContent') as HTMLElement;
    
    if (info?.data?.optimization?.enabled) {
      resultContent.innerHTML = `
        <div class="optimization-stats">
          <h3>ğŸ¯ ä¼˜åŒ–æ•ˆæœ</h3>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">æ€»åˆ†ç±»æ•°</span>
              <span class="stat-value">${info.data.optimization.totalCategories}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">æ€»ç½‘ç«™æ•°</span>
              <span class="stat-value">${info.data.optimization.totalSites}</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">åŸå§‹å¤§å°</span>
              <span class="stat-value">${info.data.optimization.originalSizeKB}KB</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">ä¼˜åŒ–åå¤§å°</span>
              <span class="stat-value">${info.data.optimization.optimizedSizeKB}KB</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">å‹ç¼©æ¯”ä¾‹</span>
              <span class="stat-value">${info.data.optimization.compressionRatio}%</span>
            </div>
          </div>
          <div class="deployment-info">
            <h4>ğŸ“ éƒ¨ç½²è¯´æ˜</h4>
            <ol>
              <li>è§£å‹ä¸‹è½½çš„ZIPæ–‡ä»¶</li>
              <li>å°† <code>config.json</code> æ”¾åˆ°é¡¹ç›®çš„ <code>src/data/</code> ç›®å½•</li>
              <li>å°† <code>categories/</code> æ–‡ä»¶å¤¹æ”¾åˆ°é¡¹ç›®çš„ <code>public/data/</code> ç›®å½•</li>
              <li>é‡æ–°æ„å»ºå’Œéƒ¨ç½²é¡¹ç›®</li>
            </ol>
          </div>
        </div>
      `;
    } else {
      resultContent.innerHTML = `
        <div class="traditional-info">
          <h3>ğŸ“„ ä¼ ç»Ÿé…ç½®æ–‡ä»¶</h3>
          <p>å·²ç”Ÿæˆä¼ ç»Ÿæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç›´æ¥æ›¿æ¢é¡¹ç›®ä¸­çš„é…ç½®æ–‡ä»¶å³å¯ã€‚</p>
          <div class="deployment-info">
            <h4>ğŸ“ éƒ¨ç½²è¯´æ˜</h4>
            <ol>
              <li>å°†ä¸‹è½½çš„ <code>config.json</code> æ”¾åˆ°é¡¹ç›®çš„ <code>src/data/</code> ç›®å½•</li>
              <li>é‡æ–°æ„å»ºå’Œéƒ¨ç½²é¡¹ç›®</li>
            </ol>
          </div>
        </div>
      `;
    }
    
    resultSection.style.display = 'block';
  }

  function showError(message: string) {
    const errorContent = document.getElementById('errorContent') as HTMLElement;
    errorContent.innerHTML = `
      <div class="error-message">
        <p>${message}</p>
        <button onclick="location.reload()" class="retry-btn">ğŸ”„ é‡è¯•</button>
      </div>
    `;
    errorSection.style.display = 'block';
  }
</script>

<style>
  .generator-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 2rem;
  }

  .generator-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .generator-header h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .form-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .form-section h2 {
    margin-bottom: 1.5rem;
    color: #333;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #555;
  }

  .form-group input[type="text"],
  .form-group input[type="number"],
  .form-group input[type="file"] {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #e1e5e9;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }

  .form-group input:focus {
    outline: none;
    border-color: #667eea;
  }

  .form-group small {
    display: block;
    margin-top: 0.5rem;
    color: #666;
    font-size: 0.875rem;
  }

  .checkbox-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-weight: 600;
  }

  .checkbox-label input[type="checkbox"] {
    margin-right: 0.75rem;
    transform: scale(1.2);
  }

  .optimization-options {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #667eea;
  }

  .generate-btn {
    width: 100%;
    padding: 1rem 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
  }

  .generate-btn:hover:not(:disabled) {
    transform: translateY(-2px);
  }

  .generate-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .result-section,
  .error-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .result-section {
    border-left: 4px solid #28a745;
  }

  .error-section {
    border-left: 4px solid #dc3545;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }

  .stat-item {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
  }

  .stat-label {
    display: block;
    font-size: 0.875rem;
    color: #666;
    margin-bottom: 0.5rem;
  }

  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #333;
  }

  .deployment-info {
    margin-top: 2rem;
    padding: 1rem;
    background: #e3f2fd;
    border-radius: 8px;
  }

  .deployment-info code {
    background: #fff;
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
  }

  .template-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 3rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    text-align: center;
  }

  .template-links {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-top: 1rem;
  }

  .template-link {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #f8f9fa;
    color: #333;
    text-decoration: none;
    border-radius: 8px;
    border: 2px solid #e1e5e9;
    transition: all 0.3s ease;
  }

  .template-link:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .retry-btn {
    margin-top: 1rem;
    padding: 0.5rem 1rem;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  @media (max-width: 768px) {
    .generator-container {
      padding: 1rem;
    }
    
    .template-links {
      flex-direction: column;
      align-items: center;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</Layout>

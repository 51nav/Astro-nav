---
/**
 * ç»¼åˆç«¯åˆ°ç«¯æµ‹è¯•é¡µé¢
 * Week 3 - ä»»åŠ¡3.2æœ€ç»ˆéªŒè¯
 */

import LoadingIndicator from '../../../components/LoadingIndicator.astro';
import PerformanceMonitor from '../../../components/PerformanceMonitor.astro';
import ErrorMessage from '../../../components/ErrorMessage.astro';
import { ConfigManager } from '../../../utils/ConfigManager';
import { LazyLoader } from '../../../utils/LazyLoader';
import { PreloadStrategy } from '../../../utils/PreloadStrategy';
import { PerformanceMonitor as PerformanceMonitorClass } from '../../../utils/PerformanceMonitor';
import { defaultErrorHandler } from '../../../utils/ErrorHandler';
import { defaultLocalStorageCache } from '../../../utils/LocalStorageCache';

// æµ‹è¯•ç»“æœæ¥å£
interface E2ETestResult {
  name: string;
  success: boolean;
  duration: number;
  details: any;
  error?: string;
  category: 'workflow' | 'integration' | 'performance' | 'reliability';
  priority: 'critical' | 'high' | 'medium' | 'low';
}

async function runE2ETest(
  name: string,
  category: E2ETestResult['category'],
  priority: E2ETestResult['priority'],
  testFn: () => Promise<any>
): Promise<E2ETestResult> {
  const startTime = performance.now();
  try {
    const result = await testFn();
    return {
      name,
      category,
      priority,
      success: true,
      duration: performance.now() - startTime,
      details: result
    };
  } catch (error) {
    return {
      name,
      category,
      priority,
      success: false,
      duration: performance.now() - startTime,
      details: {},
      error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    };
  }
}

// åˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
const configManager = new ConfigManager();
const lazyLoader = new LazyLoader(configManager);
const preloadStrategy = new PreloadStrategy(lazyLoader, configManager);
const performanceMonitor = new PerformanceMonitorClass();

// æ‰§è¡Œå®Œæ•´çš„ç«¯åˆ°ç«¯æµ‹è¯•
const e2eTests: E2ETestResult[] = [
  // å·¥ä½œæµæµ‹è¯•
  await runE2ETest('å®Œæ•´ç”¨æˆ·å·¥ä½œæµ', 'workflow', 'critical', async () => {
    // 1. ç”¨æˆ·è®¿é—®é¡µé¢ - é…ç½®åŠ è½½
    const configStart = performance.now();
    const configResult = await configManager.loadConfig();
    const configTime = performance.now() - configStart;

    if (!configResult.success) throw new Error('é…ç½®åŠ è½½å¤±è´¥');

    // 2. ç”¨æˆ·æµè§ˆåˆ†ç±» - é¢„åŠ è½½æ‰§è¡Œ
    await preloadStrategy.executePreload();
    const preloadStats = preloadStrategy.getPreloadStats();

    // 3. ç”¨æˆ·ç‚¹å‡»åˆ†ç±» - æ‡’åŠ è½½
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length === 0) throw new Error('æ²¡æœ‰å¯ç”¨åˆ†ç±»');

    const categoryStart = performance.now();
    const categoryResult = await lazyLoader.loadCategory(categories[0]);
    const categoryTime = performance.now() - categoryStart;

    if (!categoryResult.success) throw new Error('åˆ†ç±»åŠ è½½å¤±è´¥');

    // 4. ç”¨æˆ·å†æ¬¡ç‚¹å‡» - ç¼“å­˜å‘½ä¸­
    const cacheStart = performance.now();
    const cacheResult = await lazyLoader.loadCategory(categories[0]);
    const cacheTime = performance.now() - cacheStart;

    return {
      configLoadTime: configTime,
      categoryLoadTime: categoryTime,
      cacheLoadTime: cacheTime,
      preloadSuccess: preloadStats.successRate > 0,
      cacheHit: cacheResult.fromCache,
      workflowComplete: configResult.success && categoryResult.success && cacheResult.fromCache,
      performanceGood: configTime < 500 && categoryTime < 200 && cacheTime < 50
    };
  }),

  await runE2ETest('åŒå±‚ç¼“å­˜å®Œæ•´æµç¨‹', 'integration', 'critical', async () => {
    // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
    await lazyLoader.clearCache();
    await defaultLocalStorageCache.clear();

    const categories = configManager.getAllCategoryIndexes();
    if (categories.length === 0) throw new Error('æ²¡æœ‰å¯ç”¨åˆ†ç±»');

    const testCategory = categories[0];

    // 1. é¦–æ¬¡åŠ è½½ (ç½‘ç»œ â†’ åŒå±‚ç¼“å­˜)
    const networkLoad = await lazyLoader.loadCategory(testCategory);
    const afterNetworkStats = lazyLoader.getCacheStats();

    // 2. å†…å­˜ç¼“å­˜åŠ è½½
    const memoryLoad = await lazyLoader.loadCategory(testCategory);

    // 3. æ¸…é™¤å†…å­˜ç¼“å­˜ï¼Œä¿ç•™localStorage
    await lazyLoader.clearCache();

    // 4. localStorageç¼“å­˜åŠ è½½
    const localStorageLoad = await lazyLoader.loadCategory(testCategory);
    const finalStats = lazyLoader.getCacheStats();

    return {
      networkLoadSuccess: networkLoad.success,
      memoryLoadFromCache: memoryLoad.fromCache,
      localStorageLoadFromCache: localStorageLoad.fromCache,
      dualCacheWorking: networkLoad.success && memoryLoad.fromCache && localStorageLoad.fromCache,
      cacheStats: {
        afterNetwork: afterNetworkStats,
        final: finalStats
      }
    };
  }),

  await runE2ETest('æ€§èƒ½ç›‘æ§é›†æˆéªŒè¯', 'integration', 'high', async () => {
    // æ‰§è¡Œä¸€ç³»åˆ—æ“ä½œå¹¶ç›‘æ§æ€§èƒ½
    performanceMonitor.recordConfigLoadTime(300);
    performanceMonitor.recordCategoryLoadTime(150);
    performanceMonitor.recordUserInteraction(45);

    // åŠ è½½åˆ†ç±»å¹¶è®°å½•æ€§èƒ½
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length > 0) {
      const startTime = performance.now();
      const result = await lazyLoader.loadCategory(categories[0]);
      const loadTime = performance.now() - startTime;

      performanceMonitor.recordCategoryLoadTime(loadTime);
      performanceMonitor.recordNetworkRequest(loadTime, result.success);
    }

    const metrics = performanceMonitor.getMetrics();
    const score = performanceMonitor.getPerformanceScore();
    const alerts = performanceMonitor.getAlerts();
    const recommendations = performanceMonitor.getRecommendations();

    return {
      metricsRecorded: metrics.configLoadTime > 0,
      scoreCalculated: score > 0,
      alertsGenerated: alerts.length >= 0,
      recommendationsGenerated: recommendations.length >= 0,
      monitoringWorking: metrics.configLoadTime === 300 && score > 0
    };
  }),

  await runE2ETest('é”™è¯¯å¤„ç†å®Œæ•´æµç¨‹', 'reliability', 'critical', async () => {
    // 1. è§¦å‘å„ç§é”™è¯¯
    const errors = [
      new Error('Network error'),
      new SyntaxError('Parse error'),
      new Error('Timeout error')
    ];

    const errorResults: Array<{
      errorType: any;
      handled: boolean;
      userMessage: string | undefined;
      fallbackAvailable: boolean | undefined;
    }> = [];
    for (const error of errors) {
      const result = await defaultErrorHandler.handleError(error);
      errorResults.push({
        errorType: result.error?.type,
        handled: !result.success,
        userMessage: result.error?.userMessage,
        fallbackAvailable: result.error?.fallbackAvailable
      });
    }

    // 2. æ£€æŸ¥ç³»ç»Ÿå¥åº·
    const health = defaultErrorHandler.getSystemHealth();

    // 3. éªŒè¯ç³»ç»Ÿä»å¯æ­£å¸¸å·¥ä½œ
    const categories = configManager.getAllCategoryIndexes();
    let systemWorking = false;
    if (categories.length > 0) {
      const result = await lazyLoader.loadCategory(categories[0]);
      systemWorking = result.success;
    }

    return {
      errorsHandled: errorResults.every(r => r.handled),
      userFriendlyMessages: errorResults.every(r => !!r.userMessage),
      systemHealth: health.status,
      systemStillWorking: systemWorking,
      errorHandlingComplete: errorResults.every(r => r.handled) && systemWorking
    };
  }),

  await runE2ETest('å¹¶å‘æ“ä½œå‹åŠ›æµ‹è¯•', 'performance', 'high', async () => {
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length < 3) throw new Error('åˆ†ç±»æ•°é‡ä¸è¶³');

    // å¹¶å‘åŠ è½½å¤šä¸ªåˆ†ç±»
    const concurrentPromises: Promise<any>[] = [];
    for (let i = 0; i < Math.min(5, categories.length); i++) {
      concurrentPromises.push(lazyLoader.loadCategory(categories[i]));
    }

    const startTime = performance.now();
    const results = await Promise.all(concurrentPromises);
    const totalTime = performance.now() - startTime;

    const successCount = results.filter(r => r.success).length;
    const avgTime = totalTime / results.length;

    return {
      concurrentRequests: results.length,
      successCount,
      failureCount: results.length - successCount,
      totalTime,
      avgTime,
      successRate: (successCount / results.length) * 100,
      concurrencyWorking: successCount === results.length && avgTime < 200
    };
  }),

  await runE2ETest('æ•°æ®ä¸€è‡´æ€§éªŒè¯', 'reliability', 'high', async () => {
    const categories = configManager.getAllCategoryIndexes();
    if (categories.length === 0) throw new Error('æ²¡æœ‰å¯ç”¨åˆ†ç±»');

    const testCategory = categories[0];

    // å¤šæ¬¡åŠ è½½åŒä¸€åˆ†ç±»ï¼ŒéªŒè¯æ•°æ®ä¸€è‡´æ€§
    const loads: Array<{ siteCount: number; dataHash: number }> = [];
    for (let i = 0; i < 5; i++) {
      const result = await lazyLoader.loadCategory(testCategory);
      if (result.success && result.data) {
        loads.push({
          siteCount: result.data.sites?.length || 0,
          dataHash: JSON.stringify(result.data).length // ç®€å•çš„æ•°æ®æŒ‡çº¹
        });
      }
    }

    // æ£€æŸ¥æ‰€æœ‰åŠ è½½çš„æ•°æ®æ˜¯å¦ä¸€è‡´
    const firstLoad = loads[0];
    const allConsistent = loads.every(load =>
      load.siteCount === firstLoad.siteCount &&
      load.dataHash === firstLoad.dataHash
    );

    return {
      loadCount: loads.length,
      firstLoadSiteCount: firstLoad?.siteCount || 0,
      allConsistent,
      dataIntegrity: allConsistent && loads.length === 5
    };
  }),

  await runE2ETest('å†…å­˜æ³„æ¼æ£€æµ‹', 'performance', 'medium', async () => {
    const initialMemory = performanceMonitor.getMetrics().memoryUsage;

    // æ‰§è¡Œå¤§é‡æ“ä½œ
    for (let i = 0; i < 20; i++) {
      const categories = configManager.getAllCategoryIndexes();
      if (categories.length > 0) {
        await lazyLoader.loadCategory(categories[i % categories.length]);
      }

      // è®¾ç½®å’Œåˆ é™¤ç¼“å­˜æ•°æ®
      await defaultLocalStorageCache.set(`test_${i}`, { data: 'x'.repeat(1000) });
      await defaultLocalStorageCache.delete(`test_${i}`);
    }

    // å¼ºåˆ¶åƒåœ¾å›æ”¶ (å¦‚æœå¯ç”¨)
    if ((window as any).gc) {
      (window as any).gc();
    }

    const finalMemory = performanceMonitor.getMetrics().memoryUsage;
    const memoryIncrease = finalMemory - initialMemory;

    return {
      initialMemory,
      finalMemory,
      memoryIncrease,
      memoryLeakDetected: memoryIncrease > 20, // è¶…è¿‡20MBè®¤ä¸ºå¯èƒ½æœ‰å†…å­˜æ³„æ¼
      memoryEfficient: memoryIncrease < 10
    };
  }),

  await runE2ETest('è·¨æµè§ˆå™¨å…¼å®¹æ€§', 'integration', 'medium', async () => {
    // æ£€æŸ¥å…³é”®APIæ”¯æŒ
    const apiSupport = {
      fetch: typeof fetch !== 'undefined',
      localStorage: typeof localStorage !== 'undefined',
      sessionStorage: typeof sessionStorage !== 'undefined',
      promise: typeof Promise !== 'undefined',
      asyncAwait: true, // å¦‚æœä»£ç è¿è¡Œåˆ°è¿™é‡Œè¯´æ˜æ”¯æŒ
      json: typeof JSON !== 'undefined',
      performance: typeof performance !== 'undefined'
    };

    // æµ‹è¯•å­˜å‚¨åŠŸèƒ½
    let storageWorking = false;
    try {
      localStorage.setItem('compat_test', 'test');
      storageWorking = localStorage.getItem('compat_test') === 'test';
      localStorage.removeItem('compat_test');
    } catch (error) {
      storageWorking = false;
    }

    // æµ‹è¯•ç½‘ç»œåŠŸèƒ½
    let networkWorking = false;
    try {
      const response = await fetch('/config.json', { method: 'HEAD' });
      networkWorking = response.ok;
    } catch (error) {
      networkWorking = false;
    }

    const supportedFeatures = Object.values(apiSupport).filter(Boolean).length;
    const totalFeatures = Object.keys(apiSupport).length;

    return {
      apiSupport,
      storageWorking,
      networkWorking,
      supportedFeatures,
      totalFeatures,
      compatibilityScore: (supportedFeatures / totalFeatures) * 100,
      fullyCompatible: supportedFeatures === totalFeatures && storageWorking && networkWorking
    };
  })
];

// æŒ‰ç±»åˆ«åˆ†ç»„æµ‹è¯•ç»“æœ
const testsByCategory = {
  workflow: e2eTests.filter(t => t.category === 'workflow'),
  integration: e2eTests.filter(t => t.category === 'integration'),
  performance: e2eTests.filter(t => t.category === 'performance'),
  reliability: e2eTests.filter(t => t.category === 'reliability')
};

// è®¡ç®—æ€»ä½“ç»Ÿè®¡
const e2eStats = {
  totalTests: e2eTests.length,
  passedTests: e2eTests.filter(t => t.success).length,
  failedTests: e2eTests.filter(t => !t.success).length,
  successRate: (e2eTests.filter(t => t.success).length / e2eTests.length) * 100,
  totalDuration: e2eTests.reduce((sum, t) => sum + t.duration, 0),
  criticalTestsPassed: e2eTests.filter(t => t.priority === 'critical' && t.success).length,
  criticalTestsTotal: e2eTests.filter(t => t.priority === 'critical').length
};

// æœ€ç»ˆç³»ç»ŸçŠ¶æ€
const finalSystemState = {
  configManager: {
    loaded: true,
    categoryCount: configManager.getAllCategoryIndexes().length,
    hasConfig: true
  },
  lazyLoader: lazyLoader.getCacheStats(),
  preloadStrategy: preloadStrategy.getPreloadStats(),
  performanceMonitor: {
    metrics: performanceMonitor.getMetrics(),
    score: performanceMonitor.getPerformanceScore(),
    alerts: performanceMonitor.getAlerts().length,
    recommendations: performanceMonitor.getRecommendations().length
  },
  errorHandler: defaultErrorHandler.getSystemHealth(),
  localStorage: defaultLocalStorageCache.getStats()
};
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»¼åˆç«¯åˆ°ç«¯æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .header {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .e2e-dashboard {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .dashboard-item {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
    }

    .dashboard-item.critical {
      background: #fef2f2;
      border-color: #ef4444;
    }

    .dashboard-item.high {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .dashboard-item.medium {
      background: #dbeafe;
      border-color: #3b82f6;
    }

    .dashboard-item.low {
      background: #d1fae5;
      border-color: #10b981;
    }

    .dashboard-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .dashboard-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .component-showcase {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .showcase-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .component-demo {
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }

    .demo-title {
      font-weight: 600;
      margin-bottom: 15px;
      color: #374151;
    }

    .test-categories {
      display: grid;
      gap: 30px;
    }

    .category-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .category-header {
      padding: 25px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .category-header.workflow {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
    }

    .category-header.integration {
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
    }

    .category-header.performance {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: white;
    }

    .category-header.reliability {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
    }

    .category-title {
      font-size: 24px;
      font-weight: bold;
    }

    .category-stats {
      text-align: right;
      font-size: 14px;
    }

    .test-grid {
      display: grid;
      gap: 15px;
      padding: 25px;
    }

    .test-item {
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid;
    }

    .test-item.success {
      background: #f0fdf4;
      border-left-color: #22c55e;
    }

    .test-item.failure {
      background: #fef2f2;
      border-left-color: #ef4444;
    }

    .test-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .test-name {
      font-weight: 600;
      color: #1f2937;
    }

    .test-meta {
      display: flex;
      gap: 10px;
      font-size: 12px;
      color: #6b7280;
    }

    .test-priority {
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .test-priority.critical {
      background: #fef2f2;
      color: #991b1b;
    }

    .test-priority.high {
      background: #fef3c7;
      color: #92400e;
    }

    .test-priority.medium {
      background: #dbeafe;
      color: #1e40af;
    }

    .test-priority.low {
      background: #d1fae5;
      color: #065f46;
    }

    .test-duration {
      background: #f3f4f6;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .test-details {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 14px;
    }

    .test-details pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .error-message {
      background: #fef2f2;
      color: #991b1b;
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      border-left: 3px solid #ef4444;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ¯ ç»¼åˆç«¯åˆ°ç«¯æµ‹è¯•</h1>
    <div class="subtitle">Week 3 - ä»»åŠ¡3.2æœ€ç»ˆéªŒè¯ | æµ‹è¯•æ—¶é—´: {new Date().toLocaleString()}</div>
  </div>

  <!-- E2Eæµ‹è¯•ä»ªè¡¨æ¿ -->
  <div class="e2e-dashboard">
    <h2>ğŸ“Š ç«¯åˆ°ç«¯æµ‹è¯•æ€»è§ˆ</h2>
    <div class="dashboard-grid">
      <div class={`dashboard-item ${e2eStats.successRate >= 95 ? 'low' : e2eStats.successRate >= 90 ? 'medium' : e2eStats.successRate >= 80 ? 'high' : 'critical'}`}>
        <div class="dashboard-value">{e2eStats.successRate.toFixed(1)}%</div>
        <div class="dashboard-label">æ€»ä½“æˆåŠŸç‡</div>
      </div>
      <div class={`dashboard-item ${e2eStats.criticalTestsPassed === e2eStats.criticalTestsTotal ? 'low' : 'critical'}`}>
        <div class="dashboard-value">{e2eStats.criticalTestsPassed}/{e2eStats.criticalTestsTotal}</div>
        <div class="dashboard-label">å…³é”®æµ‹è¯•é€šè¿‡</div>
      </div>
      <div class="dashboard-item medium">
        <div class="dashboard-value">{e2eStats.passedTests}</div>
        <div class="dashboard-label">é€šè¿‡æµ‹è¯•</div>
      </div>
      <div class="dashboard-item">
        <div class="dashboard-value">{e2eStats.failedTests}</div>
        <div class="dashboard-label">å¤±è´¥æµ‹è¯•</div>
      </div>
      <div class="dashboard-item">
        <div class="dashboard-value">{(e2eStats.totalDuration / 1000).toFixed(1)}s</div>
        <div class="dashboard-label">æ€»æµ‹è¯•æ—¶é—´</div>
      </div>
    </div>
  </div>

  <!-- ç»„ä»¶å±•ç¤º -->
  <div class="component-showcase">
    <h2>ğŸ§© æ ¸å¿ƒç»„ä»¶å®æ—¶å±•ç¤º</h2>
    <div class="showcase-grid">
      <div class="component-demo">
        <div class="demo-title">ğŸ“Š æ€§èƒ½ç›‘æ§é¢æ¿</div>
        <PerformanceMonitor
          visible={true}
          position="top-left"
          collapsible={true}
          defaultCollapsed={false}
          updateInterval={3000}
        />
      </div>

      <div class="component-demo">
        <div class="demo-title">â³ åŠ è½½æŒ‡ç¤ºå™¨</div>
        <LoadingIndicator
          visible={true}
          message="æ­£åœ¨æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•..."
          showProgress={true}
          progress={85}
          size="large"
        />
      </div>

      <div class="component-demo">
        <div class="demo-title">ğŸš¨ é”™è¯¯æ¶ˆæ¯ç»„ä»¶</div>
        <ErrorMessage
          type="CONFIG_ERROR"
          severity="high"
          message="ç«¯åˆ°ç«¯æµ‹è¯•æ£€æµ‹åˆ°é…ç½®é—®é¢˜"
          showRetry={true}
          showDetails={true}
          details="æµ‹è¯•ç¯å¢ƒé…ç½®éªŒè¯å¤±è´¥"
          dismissible={true}
        />
      </div>
    </div>
  </div>

  <!-- æŒ‰ç±»åˆ«æ˜¾ç¤ºæµ‹è¯•ç»“æœ -->
  <div class="test-categories">
    {Object.entries(testsByCategory).map(([category, tests]) => (
      <div class="category-section">
        <div class={`category-header ${category}`}>
          <div class="category-title">
            {category === 'workflow' ? 'ğŸ”„ å·¥ä½œæµæµ‹è¯•' :
             category === 'integration' ? 'ğŸ”— é›†æˆæµ‹è¯•' :
             category === 'performance' ? 'âš¡ æ€§èƒ½æµ‹è¯•' :
             'ğŸ›¡ï¸ å¯é æ€§æµ‹è¯•'}
          </div>
          <div class="category-stats">
            <div>é€šè¿‡ç‡: {((tests.filter(t => t.success).length / tests.length) * 100).toFixed(1)}%</div>
            <div>æµ‹è¯•æ•°: {tests.length}</div>
          </div>
        </div>

        <div class="test-grid">
          {tests.map((test, index) => (
            <div class={`test-item ${test.success ? 'success' : 'failure'}`}>
              <div class="test-header">
                <div class="test-name">
                  <span>{test.success ? 'âœ…' : 'âŒ'}</span>
                  {test.name}
                </div>
                <div class="test-meta">
                  <div class={`test-priority ${test.priority}`}>{test.priority}</div>
                  <div class="test-duration">{test.duration.toFixed(2)}ms</div>
                </div>
              </div>

              <div class="test-details">
                <strong>æµ‹è¯•è¯¦æƒ…:</strong>
                <pre>{JSON.stringify(test.details, null, 2)}</pre>
              </div>

              {test.error && (
                <div class="error-message">
                  <strong>é”™è¯¯ä¿¡æ¯:</strong> {test.error}
                </div>
              )}
            </div>
          ))}
        </div>
      </div>
    ))}
  </div>

  <script define:vars={{ e2eTests, e2eStats, testsByCategory, finalSystemState }} is:inline>
    console.log('ğŸ¯ ç»¼åˆç«¯åˆ°ç«¯æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('ğŸ“Š E2Eæµ‹è¯•ç»“æœ:', JSON.stringify(e2eTests, null, 2));
    console.log('ğŸ“Š E2Eæµ‹è¯•ç»Ÿè®¡:', JSON.stringify(e2eStats, null, 2));
    console.log('ğŸ“Š æŒ‰ç±»åˆ«åˆ†ç»„:', JSON.stringify(testsByCategory, null, 2));
    console.log('ğŸ¥ æœ€ç»ˆç³»ç»ŸçŠ¶æ€:', JSON.stringify(finalSystemState, null, 2));

    // ç”ŸæˆE2Eæµ‹è¯•æŠ¥å‘Š
    const generateE2EReport = () => {
      const report = {
        timestamp: new Date().toISOString(),
        testType: 'End-to-End',
        summary: e2eStats,
        testsByCategory,
        systemState: finalSystemState,
        environment: {
          userAgent: navigator.userAgent,
          viewport: `${window.innerWidth}x${window.innerHeight}`,
          timestamp: Date.now()
        }
      };

      return report;
    };

    // å¯¼å‡ºE2Eæµ‹è¯•æŠ¥å‘Š
    window.exportE2EReport = () => {
      const report = generateE2EReport();
      const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `e2e-test-report-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    };

    // æ˜¾ç¤ºE2Eæµ‹è¯•æ€»ç»“
    console.log('ğŸ“‹ E2Eæµ‹è¯•æ€»ç»“:');
    console.log(`   æ€»æµ‹è¯•æ•°: ${e2eStats.totalTests}`);
    console.log(`   é€šè¿‡æ•°: ${e2eStats.passedTests}`);
    console.log(`   å¤±è´¥æ•°: ${e2eStats.failedTests}`);
    console.log(`   æˆåŠŸç‡: ${e2eStats.successRate.toFixed(1)}%`);
    console.log(`   å…³é”®æµ‹è¯•: ${e2eStats.criticalTestsPassed}/${e2eStats.criticalTestsTotal}`);
    console.log(`   æ€»è€—æ—¶: ${(e2eStats.totalDuration / 1000).toFixed(1)}s`);

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å…³é”®æµ‹è¯•éƒ½é€šè¿‡
    const allCriticalPassed = e2eStats.criticalTestsPassed === e2eStats.criticalTestsTotal;
    if (allCriticalPassed && e2eStats.successRate >= 90) {
      console.log('ğŸ‰ æ­å–œï¼æ‰€æœ‰å…³é”®æµ‹è¯•éƒ½å·²é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œè‰¯å¥½ï¼');
    } else {
      console.log('âš ï¸ éƒ¨åˆ†å…³é”®æµ‹è¯•æœªé€šè¿‡æˆ–æˆåŠŸç‡ä¸è¶³90%ï¼Œéœ€è¦è¿›ä¸€æ­¥æ£€æŸ¥');
    }
  </script>
</body>
</html>
---
/**
 * ç«¯åˆ°ç«¯æµ‹è¯•é¡µé¢
 * Week 3 - ä»»åŠ¡1.4ç«¯åˆ°ç«¯éªŒè¯
 */

import LoadingIndicator from '../../../components/LoadingIndicator.astro';
import { ConfigManager } from '../../../utils/ConfigManager';
import { LazyLoader } from '../../../utils/LazyLoader';
import { PerformanceBenchmark } from '../../../utils/PerformanceBenchmark';

// æµ‹è¯•ç»“æœæ¥å£
interface E2ETestResult {
  name: string;
  success: boolean;
  duration: number;
  steps: Array<{
    name: string;
    success: boolean;
    duration: number;
    details?: any;
  }>;
  error?: string;
}

async function runE2ETest(
  name: string,
  steps: Array<{
    name: string;
    testFn: () => Promise<any>;
  }>
): Promise<E2ETestResult> {
  const startTime = performance.now();
  const stepResults = [];
  let overallSuccess = true;
  let error: string | undefined;

  for (const step of steps) {
    const stepStartTime = performance.now();
    try {
      const result = await step.testFn();
      stepResults.push({
        name: step.name,
        success: true,
        duration: performance.now() - stepStartTime,
        details: result
      });
    } catch (stepError) {
      const errorMessage = stepError instanceof Error ? stepError.message : 'æœªçŸ¥é”™è¯¯';
      stepResults.push({
        name: step.name,
        success: false,
        duration: performance.now() - stepStartTime,
        details: { error: errorMessage }
      });
      overallSuccess = false;
      error = `æ­¥éª¤ "${step.name}" å¤±è´¥: ${errorMessage}`;
      break; // åœæ­¢åç»­æ­¥éª¤
    }
  }

  return {
    name,
    success: overallSuccess,
    duration: performance.now() - startTime,
    steps: stepResults,
    error
  };
}

// åˆå§‹åŒ–ç»„ä»¶
const configManager = new ConfigManager();
const lazyLoader = new LazyLoader(configManager);
const benchmark = new PerformanceBenchmark();

// æ‰§è¡Œç«¯åˆ°ç«¯æµ‹è¯•
const e2eResults: E2ETestResult[] = [
  // E2Eæµ‹è¯•1: å®Œæ•´ç”¨æˆ·æµç¨‹
  await runE2ETest('å®Œæ•´ç”¨æˆ·æµç¨‹', [
    {
      name: 'åˆå§‹åŒ–ç³»ç»Ÿ',
      testFn: async () => {
        // æ¸…ç†çŠ¶æ€
        lazyLoader.clearCache();
        return { initialized: true };
      }
    },
    {
      name: 'åŠ è½½é…ç½®æ–‡ä»¶',
      testFn: async () => {
        const result = await configManager.loadOptimizedConfig();
        if (!result.success) {
          throw new Error('é…ç½®åŠ è½½å¤±è´¥');
        }
        return {
          isOptimized: result.isOptimized,
          categoryCount: configManager.getAllCategoryIndexes().length
        };
      }
    },
    {
      name: 'è·å–åˆ†ç±»åˆ—è¡¨',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        if (categories.length === 0) {
          throw new Error('æ²¡æœ‰å¯ç”¨çš„åˆ†ç±»');
        }
        return { categories, count: categories.length };
      }
    },
    {
      name: 'åŠ è½½ç¬¬ä¸€ä¸ªåˆ†ç±»',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        const result = await lazyLoader.loadCategory(categories[0]);
        if (!result.success) {
          throw new Error('åˆ†ç±»åŠ è½½å¤±è´¥');
        }
        return {
          categoryIndex: categories[0],
          siteCount: result.data?.sites?.length,
          fromCache: result.fromCache
        };
      }
    },
    {
      name: 'éªŒè¯ç¼“å­˜æœºåˆ¶',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        const result = await lazyLoader.loadCategory(categories[0]);
        if (!result.fromCache) {
          throw new Error('ç¼“å­˜æœºåˆ¶æœªå·¥ä½œ');
        }
        return { fromCache: true, loadTime: result.loadTime };
      }
    },
    {
      name: 'åˆ‡æ¢åˆ°å…¶ä»–åˆ†ç±»',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        if (categories.length < 2) {
          return { skipped: true, reason: 'åªæœ‰ä¸€ä¸ªåˆ†ç±»' };
        }
        
        const result = await lazyLoader.loadCategory(categories[1]);
        if (!result.success) {
          throw new Error('åˆ†ç±»åˆ‡æ¢å¤±è´¥');
        }
        return {
          categoryIndex: categories[1],
          siteCount: result.data?.sites?.length,
          fromCache: result.fromCache
        };
      }
    }
  ]),

  // E2Eæµ‹è¯•2: é”™è¯¯æ¢å¤æµç¨‹
  await runE2ETest('é”™è¯¯æ¢å¤æµç¨‹', [
    {
      name: 'å°è¯•åŠ è½½æ— æ•ˆåˆ†ç±»',
      testFn: async () => {
        const result = await lazyLoader.loadCategory(-1);
        if (result.success) {
          throw new Error('åº”è¯¥å¤±è´¥ä½†æˆåŠŸäº†');
        }
        return { errorHandled: true, error: result.error };
      }
    },
    {
      name: 'ç³»ç»ŸçŠ¶æ€æ¢å¤',
      testFn: async () => {
        // éªŒè¯ç³»ç»Ÿä»ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œ
        const categories = configManager.getAllCategoryIndexes();
        const result = await lazyLoader.loadCategory(categories[0]);
        if (!result.success) {
          throw new Error('ç³»ç»Ÿæœªèƒ½ä»é”™è¯¯ä¸­æ¢å¤');
        }
        return { recovered: true };
      }
    },
    {
      name: 'ç¼“å­˜çŠ¶æ€éªŒè¯',
      testFn: async () => {
        const stats = lazyLoader.getCacheStats();
        return {
          cacheSize: stats.cacheSize,
          cacheWorking: stats.cacheSize > 0
        };
      }
    }
  ]),

  // E2Eæµ‹è¯•3: æ€§èƒ½å‹åŠ›æµ‹è¯•
  await runE2ETest('æ€§èƒ½å‹åŠ›æµ‹è¯•', [
    {
      name: 'æ‰¹é‡åŠ è½½æµ‹è¯•',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        const testCategories = categories.slice(0, Math.min(5, categories.length));
        
        const startTime = performance.now();
        const results = await lazyLoader.loadMultipleCategories(testCategories);
        const duration = performance.now() - startTime;
        
        const successCount = Array.from(results.values()).filter(r => r.success).length;
        
        return {
          requestedCount: testCategories.length,
          successCount,
          duration,
          avgTimePerCategory: duration / testCategories.length,
          allSuccessful: successCount === testCategories.length
        };
      }
    },
    {
      name: 'è¿ç»­åŠ è½½æµ‹è¯•',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        const testCategory = categories[0];
        const iterations = 10;
        
        const times = [];
        for (let i = 0; i < iterations; i++) {
          const startTime = performance.now();
          await lazyLoader.loadCategory(testCategory);
          times.push(performance.now() - startTime);
        }
        
        return {
          iterations,
          times,
          avgTime: times.reduce((sum, time) => sum + time, 0) / times.length,
          minTime: Math.min(...times),
          maxTime: Math.max(...times)
        };
      }
    },
    {
      name: 'å†…å­˜ä½¿ç”¨æ£€æŸ¥',
      testFn: async () => {
        const memoryUsage = benchmark.getMemoryUsage();
        const stats = lazyLoader.getCacheStats();
        
        return {
          memoryUsage,
          cacheStats: stats,
          memoryEfficient: !memoryUsage || memoryUsage.used < 50 // 50MBä»¥ä¸‹
        };
      }
    }
  ]),

  // E2Eæµ‹è¯•4: å…¼å®¹æ€§æµ‹è¯•
  await runE2ETest('å…¼å®¹æ€§æµ‹è¯•', [
    {
      name: 'ä¼˜åŒ–æ ¼å¼æ£€æµ‹',
      testFn: async () => {
        const result = await configManager.loadOptimizedConfig();
        return {
          formatDetected: result.success,
          isOptimized: result.isOptimized,
          fallbackWorking: true // å‡è®¾æœ‰fallbackæœºåˆ¶
        };
      }
    },
    {
      name: 'æ•°æ®æ ¼å¼éªŒè¯',
      testFn: async () => {
        const categories = configManager.getAllCategoryIndexes();
        const result = await lazyLoader.loadCategory(categories[0]);
        
        if (!result.success || !result.data) {
          throw new Error('æ•°æ®æ ¼å¼éªŒè¯å¤±è´¥');
        }
        
        const data = result.data;
        const isValidFormat = (
          typeof data.categoryIndex === 'number' &&
          typeof data.categoryName === 'string' &&
          Array.isArray(data.sites) &&
          data.sites.length > 0
        );
        
        if (!isValidFormat) {
          throw new Error('æ•°æ®æ ¼å¼ä¸ç¬¦åˆé¢„æœŸ');
        }
        
        return {
          formatValid: true,
          categoryIndex: data.categoryIndex,
          categoryName: data.categoryName,
          siteCount: data.sites.length
        };
      }
    },
    {
      name: 'è·¨æµè§ˆå™¨ç‰¹æ€§æ£€æŸ¥',
      testFn: async () => {
        const features = {
          performanceAPI: typeof performance !== 'undefined',
          promiseSupport: typeof Promise !== 'undefined',
          asyncAwaitSupport: true, // å¦‚æœä»£ç è¿è¡Œåˆ°è¿™é‡Œè¯´æ˜æ”¯æŒ
          fetchAPI: typeof fetch !== 'undefined',
          localStorageAPI: typeof localStorage !== 'undefined'
        };
        
        const supportedFeatures = Object.values(features).filter(Boolean).length;
        const totalFeatures = Object.keys(features).length;
        
        return {
          features,
          supportedFeatures,
          totalFeatures,
          compatibilityScore: (supportedFeatures / totalFeatures) * 100
        };
      }
    }
  ])
];

const successfulTests = e2eResults.filter(r => r.success).length;
const totalTests = e2eResults.length;
const successRate = (successfulTests / totalTests * 100).toFixed(1);

// è®¡ç®—æ€»ä½“ç»Ÿè®¡
const totalSteps = e2eResults.reduce((sum, test) => sum + test.steps.length, 0);
const successfulSteps = e2eResults.reduce((sum, test) => 
  sum + test.steps.filter(step => step.success).length, 0);
const stepSuccessRate = (successfulSteps / totalSteps * 100).toFixed(1);
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç«¯åˆ°ç«¯æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .summary {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .summary-item {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    
    .summary-item.success {
      background: #d4edda;
      color: #155724;
    }
    
    .summary-item.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .summary-item .value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .test-results {
      display: grid;
      gap: 20px;
    }
    
    .test-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .test-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .test-header.success {
      background: #d4edda;
      color: #155724;
    }
    
    .test-header.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .test-content {
      padding: 20px;
    }
    
    .steps-list {
      margin-top: 15px;
    }
    
    .step-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #e5e7eb;
    }
    
    .step-item.success {
      border-left-color: #10b981;
      background: #f0fdf4;
    }
    
    .step-item.error {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .step-name {
      font-weight: 500;
    }
    
    .step-duration {
      font-size: 0.9em;
      color: #6b7280;
    }
    
    .error-message {
      background: #fef2f2;
      color: #991b1b;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid #ef4444;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”„ ç«¯åˆ°ç«¯æµ‹è¯•</h1>
    <div class="subtitle">Week 3 - ä»»åŠ¡1.4ç«¯åˆ°ç«¯éªŒè¯ | æµ‹è¯•æ—¶é—´: {new Date().toLocaleString()}</div>
  </div>

  <div class="summary">
    <div class={`summary-item ${successRate === '100.0' ? 'success' : 'warning'}`}>
      <div class="value">{successRate}%</div>
      <div class="label">æµ‹è¯•é€šè¿‡ç‡</div>
    </div>
    <div class="summary-item">
      <div class="value">{successfulTests}/{totalTests}</div>
      <div class="label">é€šè¿‡æµ‹è¯•</div>
    </div>
    <div class={`summary-item ${stepSuccessRate === '100.0' ? 'success' : 'warning'}`}>
      <div class="value">{stepSuccessRate}%</div>
      <div class="label">æ­¥éª¤é€šè¿‡ç‡</div>
    </div>
    <div class="summary-item">
      <div class="value">{successfulSteps}/{totalSteps}</div>
      <div class="label">é€šè¿‡æ­¥éª¤</div>
    </div>
  </div>

  <div class="test-results">
    {e2eResults.map((result, index) => (
      <div class="test-card">
        <div class={`test-header ${result.success ? 'success' : 'error'}`}>
          <div class="test-name">
            <span>{result.success ? 'âœ…' : 'âŒ'}</span>
            E2Eæµ‹è¯• {index + 1}: {result.name}
          </div>
          <div class="test-duration">{result.duration.toFixed(2)}ms</div>
        </div>
        <div class="test-content">
          <div class="steps-list">
            <strong>æµ‹è¯•æ­¥éª¤:</strong>
            {result.steps.map((step, stepIndex) => (
              <div class={`step-item ${step.success ? 'success' : 'error'}`}>
                <div class="step-name">
                  <span>{step.success ? 'âœ…' : 'âŒ'}</span>
                  {stepIndex + 1}. {step.name}
                </div>
                <div class="step-duration">{step.duration.toFixed(2)}ms</div>
              </div>
            ))}
          </div>
          {result.error && (
            <div class="error-message">
              <strong>é”™è¯¯ä¿¡æ¯:</strong> {result.error}
            </div>
          )}
        </div>
      </div>
    ))}
  </div>

  <script define:vars={{ e2eResults }}>
    console.log('ğŸ”„ ç«¯åˆ°ç«¯æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('ğŸ“Š E2Eæµ‹è¯•ç»“æœ:', JSON.stringify(e2eResults, null, 2));
  </script>
</body>
</html>

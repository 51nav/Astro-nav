---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Headersè°ƒè¯•">
  <div style="max-width: 800px; margin: 2rem auto; padding: 2rem;">
    <h1>ğŸ” Headersè°ƒè¯•å·¥å…·</h1>
    
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
      <h3>æµ‹è¯•ä¸åŒçš„è¯·æ±‚æ–¹å¼</h3>
      <p>è¿™ä¸ªå·¥å…·ä¼šæ˜¾ç¤ºæœåŠ¡å™¨æ¥æ”¶åˆ°çš„æ‰€æœ‰headersä¿¡æ¯</p>
    </div>
    
    <!-- æµ‹è¯•1: ç®€å•POST -->
    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #dee2e6;">
      <h4>æµ‹è¯•1: ç®€å•JSON POST</h4>
      <button id="testJson" style="background: #007bff; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px;">
        å‘é€JSONè¯·æ±‚
      </button>
    </div>
    
    <!-- æµ‹è¯•2: FormData (JavaScript) -->
    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #dee2e6;">
      <h4>æµ‹è¯•2: JavaScript FormData</h4>
      <input type="file" id="jsFile" accept=".csv,.txt" style="margin-bottom: 0.5rem;">
      <br>
      <button id="testJsFormData" style="background: #28a745; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px;">
        å‘é€JS FormData
      </button>
    </div>
    
    <!-- æµ‹è¯•3: HTMLè¡¨å•æäº¤ -->
    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #dee2e6;">
      <h4>æµ‹è¯•3: HTMLè¡¨å•æäº¤</h4>
      <form action="/api/debug-headers" method="post" enctype="multipart/form-data">
        <input type="file" name="htmlFile" accept=".csv,.txt" style="margin-bottom: 0.5rem;">
        <br>
        <input type="text" name="testField" value="HTML Form Test" style="margin-bottom: 0.5rem; padding: 0.25rem;">
        <br>
        <button type="submit" style="background: #dc3545; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px;">
          æäº¤HTMLè¡¨å•
        </button>
      </form>
    </div>
    
    <!-- æµ‹è¯•4: Fetch with explicit headers -->
    <div style="background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #dee2e6;">
      <h4>æµ‹è¯•4: æ‰‹åŠ¨è®¾ç½®Headers</h4>
      <input type="file" id="manualFile" accept=".csv,.txt" style="margin-bottom: 0.5rem;">
      <br>
      <button id="testManualHeaders" style="background: #6f42c1; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px;">
        æ‰‹åŠ¨è®¾ç½®Content-Type
      </button>
    </div>
    
    <div id="result" style="margin-top: 2rem; padding: 1rem; background: #f8f9fa; border-radius: 4px; display: none;">
      <h3>è°ƒè¯•ç»“æœ:</h3>
      <pre id="resultContent" style="background: white; padding: 1rem; border-radius: 4px; overflow: auto; white-space: pre-wrap; max-height: 500px;"></pre>
    </div>
  </div>
</Layout>

<script>
  const result = document.getElementById('result') as HTMLElement;
  const resultContent = document.getElementById('resultContent') as HTMLElement;
  
  function showResult(data: any, title: string) {
    result.style.display = 'block';
    resultContent.textContent = `=== ${title} ===\n\n${JSON.stringify(data, null, 2)}`;
    result.scrollIntoView({ behavior: 'smooth' });
  }
  
  // æµ‹è¯•1: JSON POST
  document.getElementById('testJson')?.addEventListener('click', async () => {
    try {
      const response = await fetch('/api/debug-headers', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ test: 'json data' })
      });
      
      const data = await response.json();
      showResult(data, 'JSON POST æµ‹è¯•');
    } catch (error) {
      showResult({ error: error instanceof Error ? error.message : 'Unknown error' }, 'JSON POST é”™è¯¯');
    }
  });
  
  // æµ‹è¯•2: JavaScript FormData
  document.getElementById('testJsFormData')?.addEventListener('click', async () => {
    const fileInput = document.getElementById('jsFile') as HTMLInputElement;
    const file = fileInput.files?.[0];
    
    if (!file) {
      alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
      return;
    }
    
    try {
      const formData = new FormData();
      formData.append('testFile', file);
      formData.append('testField', 'JavaScript FormData Test');
      
      console.log('Sending FormData with file:', file.name, file.type, file.size);
      
      const response = await fetch('/api/debug-headers', {
        method: 'POST',
        body: formData
        // ä¸è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
      });
      
      const data = await response.json();
      showResult(data, 'JavaScript FormData æµ‹è¯•');
    } catch (error) {
      showResult({ error: error instanceof Error ? error.message : 'Unknown error' }, 'JavaScript FormData é”™è¯¯');
    }
  });
  
  // æµ‹è¯•4: æ‰‹åŠ¨è®¾ç½®Headers
  document.getElementById('testManualHeaders')?.addEventListener('click', async () => {
    const fileInput = document.getElementById('manualFile') as HTMLInputElement;
    const file = fileInput.files?.[0];
    
    if (!file) {
      alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ–‡ä»¶');
      return;
    }
    
    try {
      const formData = new FormData();
      formData.append('testFile', file);
      formData.append('testField', 'Manual Headers Test');
      
      // å°è¯•æ‰‹åŠ¨è®¾ç½®Content-Type (é€šå¸¸ä¸æ¨èï¼Œä½†ç”¨äºæµ‹è¯•)
      const response = await fetch('/api/debug-headers', {
        method: 'POST',
        headers: {
          // æ³¨æ„ï¼šæ‰‹åŠ¨è®¾ç½®multipart/form-dataé€šå¸¸ä¼šå‡ºé—®é¢˜ï¼Œå› ä¸ºç¼ºå°‘boundary
          // 'Content-Type': 'multipart/form-data'
        },
        body: formData
      });
      
      const data = await response.json();
      showResult(data, 'æ‰‹åŠ¨Headers æµ‹è¯•');
    } catch (error) {
      showResult({ error: error instanceof Error ? error.message : 'Unknown error' }, 'æ‰‹åŠ¨Headers é”™è¯¯');
    }
  });
  
  // åˆ›å»ºæµ‹è¯•æ–‡ä»¶çš„è¾…åŠ©å‡½æ•°
  function createTestFile() {
    const content = 'test,data\n1,hello\n2,world';
    const blob = new Blob([content], { type: 'text/csv' });
    return new File([blob], 'test.csv', { type: 'text/csv' });
  }
  
  // ä¸ºæ²¡æœ‰æ–‡ä»¶çš„æµ‹è¯•è‡ªåŠ¨åˆ›å»ºæ–‡ä»¶
  document.getElementById('testJsFormData')?.addEventListener('click', () => {
    const fileInput = document.getElementById('jsFile') as HTMLInputElement;
    if (!fileInput.files?.length) {
      // åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç”¨äºæµ‹è¯•
      const testFile = createTestFile();
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(testFile);
      fileInput.files = dataTransfer.files;
    }
  });
  
  document.getElementById('testManualHeaders')?.addEventListener('click', () => {
    const fileInput = document.getElementById('manualFile') as HTMLInputElement;
    if (!fileInput.files?.length) {
      const testFile = createTestFile();
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(testFile);
      fileInput.files = dataTransfer.files;
    }
  });
</script>
</Layout>

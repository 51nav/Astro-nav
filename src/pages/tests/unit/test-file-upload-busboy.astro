---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Busboyæ–‡ä»¶ä¸Šä¼ æµ‹è¯•">
  <div style="max-width: 600px; margin: 2rem auto; padding: 2rem;">
    <h1>ğŸš€ Busboyæ–‡ä»¶ä¸Šä¼ æµ‹è¯•</h1>
    <p style="color: #666; margin-bottom: 2rem;">
      ä½¿ç”¨busboyåº“æ‰‹åŠ¨è§£æmultipartæ•°æ®ï¼Œç»•è¿‡Astroçš„FormDataé™åˆ¶
    </p>
    
    <form id="fileForm" enctype="multipart/form-data" style="background: #f5f5f5; padding: 2rem; border-radius: 8px; margin-bottom: 2rem;">
      <div style="margin-bottom: 1rem;">
        <label for="testFile">é€‰æ‹©æ–‡ä»¶:</label>
        <input type="file" id="testFile" name="testFile" accept=".csv,.txt" required>
        <small style="display: block; margin-top: 0.5rem; color: #666;">
          è¯·é€‰æ‹©ä¸€ä¸ªå°çš„CSVæˆ–TXTæ–‡ä»¶è¿›è¡Œæµ‹è¯•
        </small>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="testName">æµ‹è¯•åç§°:</label>
        <input type="text" id="testName" name="testName" value="Busboy Upload Test" required>
      </div>
      
      <div style="margin-bottom: 1rem;">
        <label for="description">æè¿°:</label>
        <textarea id="description" name="description" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">è¿™æ˜¯ä¸€ä¸ªä½¿ç”¨busboyåº“çš„æ–‡ä»¶ä¸Šä¼ æµ‹è¯•</textarea>
      </div>
      
      <button type="submit" style="background: #007bff; color: white; padding: 0.75rem 1.5rem; border: none; border-radius: 4px; font-size: 1rem;">
        ğŸš€ ä¸Šä¼ æµ‹è¯• (Busboy)
      </button>
    </form>
    
    <!-- åˆ›å»ºæµ‹è¯•æ–‡ä»¶æŒ‰é’® -->
    <div style="background: #e9ecef; padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
      <h3>ğŸ“‹ åˆ›å»ºæµ‹è¯•æ–‡ä»¶</h3>
      <button id="createTestFile" style="background: #28a745; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px; margin-right: 1rem;">
        åˆ›å»ºCSVæµ‹è¯•æ–‡ä»¶
      </button>
      <button id="createTextFile" style="background: #17a2b8; color: white; padding: 0.5rem 1rem; border: none; border-radius: 4px;">
        åˆ›å»ºTXTæµ‹è¯•æ–‡ä»¶
      </button>
      <small style="display: block; margin-top: 0.5rem; color: #666;">
        ç‚¹å‡»æŒ‰é’®ä¼šåˆ›å»ºå¹¶ä¸‹è½½æµ‹è¯•æ–‡ä»¶
      </small>
    </div>
    
    <div id="result" style="padding: 1rem; background: #f8f9fa; border-radius: 4px; display: none;">
      <h3>æµ‹è¯•ç»“æœ:</h3>
      <pre id="resultContent" style="background: white; padding: 1rem; border-radius: 4px; overflow: auto; white-space: pre-wrap; max-height: 400px;"></pre>
    </div>
  </div>
</Layout>

<script>
  const form = document.getElementById('fileForm') as HTMLFormElement;
  const result = document.getElementById('result') as HTMLElement;
  const resultContent = document.getElementById('resultContent') as HTMLElement;
  const createTestFile = document.getElementById('createTestFile') as HTMLButtonElement;
  const createTextFile = document.getElementById('createTextFile') as HTMLButtonElement;
  
  // åˆ›å»ºCSVæµ‹è¯•æ–‡ä»¶
  createTestFile.addEventListener('click', () => {
    const csvContent = `name,age,city,occupation
John Doe,25,New York,Developer
Jane Smith,30,Los Angeles,Designer
Bob Johnson,35,Chicago,Manager
Alice Brown,28,Houston,Analyst`;
    
    downloadFile(csvContent, 'test-data.csv', 'text/csv');
  });
  
  // åˆ›å»ºTXTæµ‹è¯•æ–‡ä»¶
  createTextFile.addEventListener('click', () => {
    const txtContent = `è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬æ–‡ä»¶
ç”¨äºæµ‹è¯•busboyæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½

åŒ…å«ä¸­æ–‡å­—ç¬¦æµ‹è¯•
åŒ…å«ç‰¹æ®Šå­—ç¬¦: !@#$%^&*()
åŒ…å«æ•°å­—: 123456789

æ–‡ä»¶åˆ›å»ºæ—¶é—´: ${new Date().toLocaleString()}`;
    
    downloadFile(txtContent, 'test-text.txt', 'text/plain');
  });
  
  function downloadFile(content: string, filename: string, mimeType: string) {
    const blob = new Blob([content], { type: mimeType });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
    
    alert(`${filename} å·²ä¸‹è½½ï¼Œè¯·é€‰æ‹©è¯¥æ–‡ä»¶è¿›è¡Œä¸Šä¼ æµ‹è¯•`);
  }
  
  function showResult(data: any, isError = false) {
    result.style.display = 'block';
    resultContent.style.color = isError ? 'red' : 'green';
    resultContent.textContent = JSON.stringify(data, null, 2);
    
    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
    result.scrollIntoView({ behavior: 'smooth' });
  }
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    console.log('=== Client Busboy Upload Test ===');
    
    const formData = new FormData(form);
    
    // æ‰“å°FormDataå†…å®¹
    console.log('FormData entries:');
    for (const [key, value] of formData.entries()) {
      if (value instanceof File) {
        console.log(`${key}:`, {
          name: value.name,
          size: value.size,
          type: value.type,
          lastModified: value.lastModified
        });
      } else {
        console.log(`${key}:`, value);
      }
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'â³ ä¸Šä¼ ä¸­...';
    submitBtn.disabled = true;
    
    try {
      console.log('Sending busboy upload request...');
      
      const response = await fetch('/api/test-file-busboy', {
        method: 'POST',
        body: formData
        // ä¸è®¾ç½®Content-Typeï¼Œè®©æµè§ˆå™¨è‡ªåŠ¨è®¾ç½®
      });
      
      console.log('Response status:', response.status);
      console.log('Response headers:', Object.fromEntries(response.headers.entries()));
      
      if (response.ok) {
        const data = await response.json();
        console.log('Success response:', data);
        showResult(data);
      } else {
        const errorData = await response.json();
        console.error('Error response:', errorData);
        showResult(errorData, true);
      }
      
    } catch (error) {
      console.error('Request failed:', error);
      showResult({ 
        error: 'Network Error', 
        message: error instanceof Error ? error.message : 'Unknown error',
        type: 'Busboy Upload Failed'
      }, true);
    } finally {
      // æ¢å¤æŒ‰é’®çŠ¶æ€
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    }
  });
</script>
</Layout>

---
/**
 * é”™è¯¯å¤„ç†æµ‹è¯•é¡µé¢
 * Week 3 - ä»»åŠ¡2.3éªŒè¯
 */

import ErrorMessage from '../../../components/ErrorMessage.astro';
import { ErrorHandler, ErrorType, ErrorSeverity } from '../../../utils/ErrorHandler';

// æµ‹è¯•ç»“æœæ¥å£
interface TestResult {
  name: string;
  success: boolean;
  duration: number;
  details: any;
  error?: string;
}

async function runTest(name: string, testFn: () => any): Promise<TestResult> {
  const startTime = performance.now();
  try {
    const result = testFn();
    return {
      name,
      success: true,
      duration: performance.now() - startTime,
      details: result
    };
  } catch (error) {
    return {
      name,
      success: false,
      duration: performance.now() - startTime,
      details: {},
      error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
    };
  }
}

// åˆ›å»ºé”™è¯¯å¤„ç†å®ä¾‹
const errorHandler = new ErrorHandler();

// æ‰§è¡Œæµ‹è¯•
const testResults: TestResult[] = [
  // æµ‹è¯•1: é”™è¯¯å¤„ç†å™¨åˆå§‹åŒ–
  await runTest('é”™è¯¯å¤„ç†å™¨åˆå§‹åŒ–', () => {
    const stats = errorHandler.getErrorStats();
    const health = errorHandler.getSystemHealth();
    
    return {
      initialized: true,
      totalErrors: stats.totalErrors,
      systemStatus: health.status,
      systemScore: health.score
    };
  }),

  // æµ‹è¯•2: ç½‘ç»œé”™è¯¯å¤„ç†
  await runTest('ç½‘ç»œé”™è¯¯å¤„ç†', async () => {
    const networkError = new Error('fetch failed');
    networkError.name = 'NetworkError';
    
    const result = await errorHandler.handleError(networkError, {
      type: 'network',
      operation: 'loadConfig'
    });
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      userMessage: result.error?.userMessage,
      retryable: result.error?.retryable,
      fallbackAvailable: result.error?.fallbackAvailable
    };
  }),

  // æµ‹è¯•3: è¶…æ—¶é”™è¯¯å¤„ç†
  await runTest('è¶…æ—¶é”™è¯¯å¤„ç†', async () => {
    const timeoutError = new Error('Request timeout');
    timeoutError.name = 'TimeoutError';
    
    const result = await errorHandler.handleError(timeoutError, {
      type: 'network',
      operation: 'loadCategory'
    });
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      severity: result.error?.severity,
      userMessage: result.error?.userMessage,
      timeoutDetected: result.error?.type === ErrorType.TIMEOUT_ERROR
    };
  }),

  // æµ‹è¯•4: æ•°æ®è§£æé”™è¯¯å¤„ç†
  await runTest('æ•°æ®è§£æé”™è¯¯å¤„ç†', async () => {
    const parseError = new SyntaxError('Unexpected token in JSON');
    
    const result = await errorHandler.handleError(parseError, {
      type: 'data',
      operation: 'parseConfig'
    });
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      parseErrorDetected: result.error?.type === ErrorType.PARSE_ERROR,
      fallbackAvailable: result.error?.fallbackAvailable,
      retryable: result.error?.retryable
    };
  }),

  // æµ‹è¯•5: é…ç½®é”™è¯¯å¤„ç†
  await runTest('é…ç½®é”™è¯¯å¤„ç†', async () => {
    const configError = new Error('Config file not found');
    
    const result = await errorHandler.handleError(configError, {
      type: 'config',
      operation: 'loadConfig',
      path: '/config.json'
    });
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      configErrorDetected: result.error?.type === ErrorType.CONFIG_ERROR,
      severity: result.error?.severity,
      context: result.error?.context
    };
  }),

  // æµ‹è¯•6: ç¼“å­˜é”™è¯¯å¤„ç†
  await runTest('ç¼“å­˜é”™è¯¯å¤„ç†', async () => {
    const cacheError = new Error('Cache corruption detected');
    
    const result = await errorHandler.handleError(cacheError, {
      type: 'cache',
      operation: 'cache',
      cacheKey: 'category-0'
    });
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      cacheErrorDetected: result.error?.type === ErrorType.CACHE_ERROR,
      severity: result.error?.severity,
      lowSeverity: result.error?.severity === ErrorSeverity.LOW
    };
  }),

  // æµ‹è¯•7: é¢„åŠ è½½é”™è¯¯å¤„ç†
  await runTest('é¢„åŠ è½½é”™è¯¯å¤„ç†', async () => {
    const preloadError = new Error('Preload failed');
    
    const result = await errorHandler.handleError(preloadError, {
      type: 'preload',
      operation: 'preload',
      categoryIndex: 1
    });
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      preloadErrorDetected: result.error?.type === ErrorType.PRELOAD_ERROR,
      retryable: result.error?.retryable,
      fallbackAvailable: result.error?.fallbackAvailable
    };
  }),

  // æµ‹è¯•8: å­˜å‚¨é”™è¯¯å¤„ç†
  await runTest('å­˜å‚¨é”™è¯¯å¤„ç†', async () => {
    const storageError = new Error('QuotaExceededError');
    storageError.name = 'QuotaExceededError';
    
    const result = await errorHandler.handleError(storageError);
    
    return {
      errorHandled: !result.success,
      errorType: result.error?.type,
      storageErrorDetected: result.error?.type === ErrorType.STORAGE_ERROR,
      userMessage: result.error?.userMessage,
      fallbackAvailable: result.error?.fallbackAvailable
    };
  }),

  // æµ‹è¯•9: é”™è¯¯ç»Ÿè®¡åŠŸèƒ½
  await runTest('é”™è¯¯ç»Ÿè®¡åŠŸèƒ½', () => {
    const stats = errorHandler.getErrorStats();
    
    return {
      totalErrors: stats.totalErrors,
      hasErrorsByType: Object.keys(stats.errorsByType).length > 0,
      hasErrorsBySeverity: Object.keys(stats.errorsBySeverity).length > 0,
      hasRecentErrors: stats.recentErrors.length >= 0,
      statsWorking: stats.totalErrors >= 0
    };
  }),

  // æµ‹è¯•10: ç³»ç»Ÿå¥åº·æ£€æŸ¥
  await runTest('ç³»ç»Ÿå¥åº·æ£€æŸ¥', () => {
    const health = errorHandler.getSystemHealth();
    
    return {
      status: health.status,
      score: health.score,
      issueCount: health.issues.length,
      recommendationCount: health.recommendations.length,
      healthCheckWorking: typeof health.score === 'number' && health.score >= 0
    };
  }),

  // æµ‹è¯•11: é”™è¯¯æ—¥å¿—ç®¡ç†
  await runTest('é”™è¯¯æ—¥å¿—ç®¡ç†', () => {
    const logBefore = errorHandler.getErrorLog();
    const lengthBefore = logBefore.length;
    
    errorHandler.clearErrorLog();
    
    const logAfter = errorHandler.getErrorLog();
    const lengthAfter = logAfter.length;
    
    return {
      logLengthBefore: lengthBefore,
      logLengthAfter: lengthAfter,
      clearWorking: lengthAfter === 0,
      logManagementWorking: true
    };
  })
];

const successCount = testResults.filter(r => r.success).length;
const totalTests = testResults.length;
const successRate = (successCount / totalTests * 100).toFixed(1);

// è·å–æœ€ç»ˆç»Ÿè®¡
const finalStats = errorHandler.getErrorStats();
const finalHealth = errorHandler.getSystemHealth();
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>é”™è¯¯å¤„ç†æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .demo-section {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .demo-item {
      padding: 20px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }
    
    .demo-controls {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }
    
    .demo-controls button {
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s ease;
    }
    
    .demo-controls button:hover {
      background: #f3f4f6;
      border-color: #9ca3af;
    }
    
    .demo-controls button.primary {
      background: #3b82f6;
      color: white;
      border-color: #3b82f6;
    }
    
    .demo-controls button.danger {
      background: #ef4444;
      color: white;
      border-color: #ef4444;
    }
    
    .summary {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }
    
    .summary-item {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      background: #f8f9fa;
    }
    
    .summary-item.success {
      background: #d4edda;
      color: #155724;
    }
    
    .summary-item.warning {
      background: #fff3cd;
      color: #856404;
    }
    
    .summary-item .value {
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .summary-item .label {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .test-results {
      display: grid;
      gap: 20px;
    }
    
    .test-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .test-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .test-header.success {
      background: #d4edda;
      color: #155724;
    }
    
    .test-header.error {
      background: #f8d7da;
      color: #721c24;
    }
    
    .test-name {
      font-size: 18px;
      font-weight: 600;
    }
    
    .test-duration {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .test-content {
      padding: 20px;
    }
    
    .test-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .test-details pre {
      margin: 0;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      border-left: 4px solid #dc3545;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ›¡ï¸ é”™è¯¯å¤„ç†æµ‹è¯•</h1>
    <div class="subtitle">Week 3 - ä»»åŠ¡2.3éªŒè¯ | æµ‹è¯•æ—¶é—´: {new Date().toLocaleString()}</div>
  </div>

  <!-- é”™è¯¯æ¶ˆæ¯æ¼”ç¤º -->
  <div class="demo-section">
    <h2>ğŸš¨ é”™è¯¯æ¶ˆæ¯ç»„ä»¶æ¼”ç¤º</h2>
    <div class="demo-grid">
      <div class="demo-item">
        <h4>ç½‘ç»œé”™è¯¯ (é«˜çº§)</h4>
        <ErrorMessage 
          type="NETWORK_ERROR"
          severity="high"
          message="ç½‘ç»œè¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯•..."
          showRetry={true}
          showDetails={true}
          details="Error: fetch failed at line 123"
          dismissible={true}
        />
      </div>
      
      <div class="demo-item">
        <h4>é…ç½®é”™è¯¯ (ä¸¥é‡)</h4>
        <ErrorMessage 
          type="CONFIG_ERROR"
          severity="critical"
          message="é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥ï¼Œå·²åˆ‡æ¢åˆ°å¤‡ç”¨é…ç½®"
          showRetry={true}
          dismissible={true}
        />
      </div>
      
      <div class="demo-item">
        <h4>ç¼“å­˜é”™è¯¯ (ä½çº§)</h4>
        <ErrorMessage 
          type="CACHE_ERROR"
          severity="low"
          message="ç¼“å­˜å·²æ¸…ç†ï¼Œæ­£åœ¨é‡æ–°åŠ è½½..."
          autoHide={5000}
          dismissible={true}
        />
      </div>
      
      <div class="demo-item">
        <h4>é¢„åŠ è½½é”™è¯¯ (ä¸­çº§)</h4>
        <ErrorMessage 
          type="PRELOAD_ERROR"
          severity="medium"
          message="é¢„åŠ è½½å¤±è´¥ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨"
          showDetails={true}
          details="Preload timeout for category-2"
          dismissible={true}
        />
      </div>
    </div>
    
    <div class="demo-controls">
      <button onclick="triggerNetworkError()" class="danger">è§¦å‘ç½‘ç»œé”™è¯¯</button>
      <button onclick="triggerTimeoutError()" class="danger">è§¦å‘è¶…æ—¶é”™è¯¯</button>
      <button onclick="triggerParseError()" class="danger">è§¦å‘è§£æé”™è¯¯</button>
      <button onclick="triggerConfigError()" class="danger">è§¦å‘é…ç½®é”™è¯¯</button>
      <button onclick="showSuccessMessage()" class="primary">æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯</button>
    </div>
  </div>

  <!-- æµ‹è¯•ç»“æœ -->
  <div class="summary">
    <div class={`summary-item ${successRate === '100.0' ? 'success' : 'warning'}`}>
      <div class="value">{successRate}%</div>
      <div class="label">æµ‹è¯•é€šè¿‡ç‡</div>
    </div>
    <div class="summary-item">
      <div class="value">{successCount}</div>
      <div class="label">é€šè¿‡æµ‹è¯•</div>
    </div>
    <div class="summary-item">
      <div class="value">{finalStats.totalErrors}</div>
      <div class="label">é”™è¯¯è®°å½•æ•°</div>
    </div>
    <div class={`summary-item ${finalHealth.status === 'healthy' ? 'success' : 'warning'}`}>
      <div class="value">{finalHealth.score}</div>
      <div class="label">ç³»ç»Ÿå¥åº·è¯„åˆ†</div>
    </div>
  </div>

  <div class="test-results">
    {testResults.map((result, index) => (
      <div class="test-card">
        <div class={`test-header ${result.success ? 'success' : 'error'}`}>
          <div class="test-name">
            <span>{result.success ? 'âœ…' : 'âŒ'}</span>
            æµ‹è¯• {index + 1}: {result.name}
          </div>
          <div class="test-duration">{result.duration.toFixed(2)}ms</div>
        </div>
        <div class="test-content">
          <div class="test-details">
            <strong>æµ‹è¯•è¯¦æƒ…:</strong>
            <pre>{JSON.stringify(result.details, null, 2)}</pre>
          </div>
          {result.error && (
            <div class="error-message">
              <strong>é”™è¯¯ä¿¡æ¯:</strong> {result.error}
            </div>
          )}
        </div>
      </div>
    ))}
  </div>

  <script define:vars={{ testResults, finalStats, finalHealth }}>
    console.log('ğŸ›¡ï¸ é”™è¯¯å¤„ç†æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('ğŸ“Š æµ‹è¯•ç»“æœ:', JSON.stringify(testResults, null, 2));
    console.log('ğŸ“Š é”™è¯¯ç»Ÿè®¡:', JSON.stringify(finalStats, null, 2));
    console.log('ğŸ“Š ç³»ç»Ÿå¥åº·:', JSON.stringify(finalHealth, null, 2));

    // æ¼”ç¤ºå‡½æ•°
    function triggerNetworkError() {
      console.log('ğŸŒ è§¦å‘ç½‘ç»œé”™è¯¯æ¼”ç¤º');
      // è¿™é‡Œä¼šæ˜¾ç¤ºç½‘ç»œé”™è¯¯æ¶ˆæ¯
    }

    function triggerTimeoutError() {
      console.log('â° è§¦å‘è¶…æ—¶é”™è¯¯æ¼”ç¤º');
      // è¿™é‡Œä¼šæ˜¾ç¤ºè¶…æ—¶é”™è¯¯æ¶ˆæ¯
    }

    function triggerParseError() {
      console.log('ğŸ”§ è§¦å‘è§£æé”™è¯¯æ¼”ç¤º');
      // è¿™é‡Œä¼šæ˜¾ç¤ºè§£æé”™è¯¯æ¶ˆæ¯
    }

    function triggerConfigError() {
      console.log('âš™ï¸ è§¦å‘é…ç½®é”™è¯¯æ¼”ç¤º');
      // è¿™é‡Œä¼šæ˜¾ç¤ºé…ç½®é”™è¯¯æ¶ˆæ¯
    }

    function showSuccessMessage() {
      console.log('âœ… æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯');
      // è¿™é‡Œä¼šæ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    }

    // ä½¿å‡½æ•°å…¨å±€å¯ç”¨
    window.triggerNetworkError = triggerNetworkError;
    window.triggerTimeoutError = triggerTimeoutError;
    window.triggerParseError = triggerParseError;
    window.triggerConfigError = triggerConfigError;
    window.showSuccessMessage = showSuccessMessage;
  </script>
</body>
</html>

---
/**
 * ç³»ç»Ÿå‹åŠ›æµ‹è¯•é¡µé¢
 * Week 3 - ä»»åŠ¡3.2å‹åŠ›æµ‹è¯•
 */

import { ConfigManager } from '../../../utils/ConfigManager';
import { LazyLoader } from '../../../utils/LazyLoader';
import { PreloadStrategy } from '../../../utils/PreloadStrategy';
import { PerformanceMonitor as PerformanceMonitorClass } from '../../../utils/PerformanceMonitor';
import { defaultLocalStorageCache } from '../../../utils/LocalStorageCache';

// æµ‹è¯•ç»“æœæ¥å£
interface StressTestResult {
  name: string;
  success: boolean;
  duration: number;
  details: any;
  error?: string;
  metrics: {
    throughput: number;
    errorRate: number;
    avgResponseTime: number;
    maxResponseTime: number;
    minResponseTime: number;
  };
}

async function runStressTest(
  name: string, 
  testFn: () => Promise<any>,
  iterations: number = 100
): Promise<StressTestResult> {
  const startTime = performance.now();
  const results: Array<{ success: boolean; duration: number; error?: string }> = [];
  
  try {
    for (let i = 0; i < iterations; i++) {
      const iterationStart = performance.now();
      try {
        await testFn();
        results.push({
          success: true,
          duration: performance.now() - iterationStart
        });
      } catch (error) {
        results.push({
          success: false,
          duration: performance.now() - iterationStart,
          error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'
        });
      }
    }
    
    const totalDuration = performance.now() - startTime;
    const successCount = results.filter(r => r.success).length;
    const durations = results.map(r => r.duration);
    
    return {
      name,
      success: successCount > iterations * 0.95, // 95%æˆåŠŸç‡
      duration: totalDuration,
      details: {
        iterations,
        successCount,
        failureCount: iterations - successCount,
        results: results.slice(0, 10) // åªä¿ç•™å‰10ä¸ªç»“æœç”¨äºå±•ç¤º
      },
      metrics: {
        throughput: iterations / (totalDuration / 1000), // æ¯ç§’æ“ä½œæ•°
        errorRate: ((iterations - successCount) / iterations) * 100,
        avgResponseTime: durations.reduce((sum, d) => sum + d, 0) / durations.length,
        maxResponseTime: Math.max(...durations),
        minResponseTime: Math.min(...durations)
      }
    };
  } catch (error) {
    return {
      name,
      success: false,
      duration: performance.now() - startTime,
      details: {},
      error: error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯',
      metrics: {
        throughput: 0,
        errorRate: 100,
        avgResponseTime: 0,
        maxResponseTime: 0,
        minResponseTime: 0
      }
    };
  }
}

// åˆå§‹åŒ–ç»„ä»¶
const configManager = new ConfigManager();
const lazyLoader = new LazyLoader(configManager);
const preloadStrategy = new PreloadStrategy(lazyLoader, configManager);
const performanceMonitor = new PerformanceMonitorClass();

// é¢„åŠ è½½é…ç½®
await configManager.loadConfig();
const categories = configManager.getAllCategoryIndexes();

// æ‰§è¡Œå‹åŠ›æµ‹è¯•
const stressTests: StressTestResult[] = [
  // æµ‹è¯•1: é…ç½®åŠ è½½å‹åŠ›æµ‹è¯•
  await runStressTest('é…ç½®åŠ è½½å‹åŠ›æµ‹è¯•', async () => {
    const result = await configManager.loadConfig();
    if (!result.success) throw new Error('é…ç½®åŠ è½½å¤±è´¥');
  }, 50),

  // æµ‹è¯•2: åˆ†ç±»åŠ è½½å‹åŠ›æµ‹è¯•
  await runStressTest('åˆ†ç±»åŠ è½½å‹åŠ›æµ‹è¯•', async () => {
    if (categories.length === 0) throw new Error('æ²¡æœ‰å¯ç”¨åˆ†ç±»');
    const randomCategory = categories[Math.floor(Math.random() * categories.length)];
    const result = await lazyLoader.loadCategory(randomCategory);
    if (!result.success) throw new Error('åˆ†ç±»åŠ è½½å¤±è´¥');
  }, 200),

  // æµ‹è¯•3: ç¼“å­˜å‹åŠ›æµ‹è¯•
  await runStressTest('ç¼“å­˜å‹åŠ›æµ‹è¯•', async () => {
    const key = `stress_test_${Math.random()}`;
    const data = { test: 'data', timestamp: Date.now(), random: Math.random() };
    
    const setResult = await defaultLocalStorageCache.set(key, data);
    if (!setResult) throw new Error('ç¼“å­˜è®¾ç½®å¤±è´¥');
    
    const getData = await defaultLocalStorageCache.get(key);
    if (!getData) throw new Error('ç¼“å­˜è·å–å¤±è´¥');
    
    await defaultLocalStorageCache.delete(key);
  }, 300),

  // æµ‹è¯•4: å¹¶å‘åŠ è½½å‹åŠ›æµ‹è¯•
  await runStressTest('å¹¶å‘åŠ è½½å‹åŠ›æµ‹è¯•', async () => {
    if (categories.length < 3) throw new Error('åˆ†ç±»æ•°é‡ä¸è¶³');
    
    const promises = [];
    for (let i = 0; i < 3; i++) {
      const categoryIndex = categories[i % categories.length];
      promises.push(lazyLoader.loadCategory(categoryIndex));
    }
    
    const results = await Promise.all(promises);
    const failedCount = results.filter(r => !r.success).length;
    if (failedCount > 0) throw new Error(`${failedCount}ä¸ªå¹¶å‘è¯·æ±‚å¤±è´¥`);
  }, 100),

  // æµ‹è¯•5: æ€§èƒ½ç›‘æ§å‹åŠ›æµ‹è¯•
  await runStressTest('æ€§èƒ½ç›‘æ§å‹åŠ›æµ‹è¯•', async () => {
    // è®°å½•å„ç§æ€§èƒ½æ•°æ®
    performanceMonitor.recordConfigLoadTime(Math.random() * 1000);
    performanceMonitor.recordCategoryLoadTime(Math.random() * 500);
    performanceMonitor.recordNetworkRequest(Math.random() * 800, Math.random() > 0.1);
    performanceMonitor.recordUserInteraction(Math.random() * 100);
    
    const metrics = performanceMonitor.getMetrics();
    if (!metrics) throw new Error('æ€§èƒ½æŒ‡æ ‡è·å–å¤±è´¥');
  }, 500),

  // æµ‹è¯•6: å†…å­˜å‹åŠ›æµ‹è¯•
  await runStressTest('å†…å­˜å‹åŠ›æµ‹è¯•', async () => {
    // åˆ›å»ºå¤§é‡æ•°æ®
    const largeData = Array.from({ length: 1000 }, (_, i) => ({
      id: i,
      data: 'x'.repeat(100),
      timestamp: Date.now(),
      random: Math.random()
    }));
    
    const key = `memory_test_${Date.now()}`;
    const setResult = await defaultLocalStorageCache.set(key, largeData);
    if (!setResult) throw new Error('å¤§æ•°æ®ç¼“å­˜å¤±è´¥');
    
    const getData = await defaultLocalStorageCache.get(key);
    if (!getData || getData.length !== largeData.length) {
      throw new Error('å¤§æ•°æ®è·å–å¤±è´¥');
    }
    
    await defaultLocalStorageCache.delete(key);
  }, 50)
];

// è®¡ç®—æ€»ä½“å‹åŠ›æµ‹è¯•ç»Ÿè®¡
const stressStats = {
  totalTests: stressTests.length,
  passedTests: stressTests.filter(t => t.success).length,
  failedTests: stressTests.filter(t => !t.success).length,
  successRate: (stressTests.filter(t => t.success).length / stressTests.length) * 100,
  totalDuration: stressTests.reduce((sum, t) => sum + t.duration, 0),
  avgThroughput: stressTests.reduce((sum, t) => sum + t.metrics.throughput, 0) / stressTests.length,
  avgErrorRate: stressTests.reduce((sum, t) => sum + t.metrics.errorRate, 0) / stressTests.length,
  avgResponseTime: stressTests.reduce((sum, t) => sum + t.metrics.avgResponseTime, 0) / stressTests.length
};

// ç³»ç»Ÿå¥åº·æ£€æŸ¥
const systemHealth = {
  memoryUsage: performanceMonitor.getMetrics().memoryUsage,
  cacheStats: lazyLoader.getCacheStats(),
  localStorageStats: defaultLocalStorageCache.getStats(),
  performanceScore: performanceMonitor.getPerformanceScore(),
  systemScore: performanceMonitor.getSystemHealth().score
};
---

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç³»ç»Ÿå‹åŠ›æµ‹è¯•</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .header {
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      text-align: center;
    }
    
    .stress-dashboard {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .dashboard-item {
      text-align: center;
      padding: 20px;
      border-radius: 8px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
    }
    
    .dashboard-item.excellent {
      background: #d1fae5;
      border-color: #10b981;
    }
    
    .dashboard-item.good {
      background: #dbeafe;
      border-color: #3b82f6;
    }
    
    .dashboard-item.warning {
      background: #fef3c7;
      border-color: #f59e0b;
    }
    
    .dashboard-item.critical {
      background: #fee2e2;
      border-color: #ef4444;
    }
    
    .dashboard-value {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .dashboard-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .system-health {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .health-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .health-item {
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid;
    }
    
    .health-item.healthy {
      background: #f0fdf4;
      border-left-color: #22c55e;
    }
    
    .health-item.warning {
      background: #fffbeb;
      border-left-color: #f59e0b;
    }
    
    .health-item.critical {
      background: #fef2f2;
      border-left-color: #ef4444;
    }
    
    .test-results {
      display: grid;
      gap: 20px;
    }
    
    .test-card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .test-header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .test-header.success {
      background: #d4edda;
      color: #155724;
    }
    
    .test-header.failure {
      background: #f8d7da;
      color: #721c24;
    }
    
    .test-name {
      font-size: 18px;
      font-weight: 600;
    }
    
    .test-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
    }
    
    .metric-item {
      text-align: center;
      padding: 10px;
      background: white;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
    }
    
    .metric-value {
      font-size: 18px;
      font-weight: bold;
      color: #1f2937;
    }
    
    .metric-label {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    
    .test-details {
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      margin: 15px;
    }
    
    .test-details pre {
      margin: 0;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ”¥ ç³»ç»Ÿå‹åŠ›æµ‹è¯•</h1>
    <div class="subtitle">Week 3 - ä»»åŠ¡3.2å‹åŠ›æµ‹è¯• | æµ‹è¯•æ—¶é—´: {new Date().toLocaleString()}</div>
  </div>

  <!-- å‹åŠ›æµ‹è¯•ä»ªè¡¨æ¿ -->
  <div class="stress-dashboard">
    <h2>ğŸ“Š å‹åŠ›æµ‹è¯•æ€»è§ˆ</h2>
    <div class="dashboard-grid">
      <div class={`dashboard-item ${stressStats.successRate >= 95 ? 'excellent' : stressStats.successRate >= 90 ? 'good' : stressStats.successRate >= 80 ? 'warning' : 'critical'}`}>
        <div class="dashboard-value">{stressStats.successRate.toFixed(1)}%</div>
        <div class="dashboard-label">æˆåŠŸç‡</div>
      </div>
      <div class={`dashboard-item ${stressStats.avgThroughput >= 100 ? 'excellent' : stressStats.avgThroughput >= 50 ? 'good' : 'warning'}`}>
        <div class="dashboard-value">{stressStats.avgThroughput.toFixed(1)}</div>
        <div class="dashboard-label">å¹³å‡ååé‡ (ops/s)</div>
      </div>
      <div class={`dashboard-item ${stressStats.avgErrorRate <= 5 ? 'excellent' : stressStats.avgErrorRate <= 10 ? 'good' : 'warning'}`}>
        <div class="dashboard-value">{stressStats.avgErrorRate.toFixed(1)}%</div>
        <div class="dashboard-label">å¹³å‡é”™è¯¯ç‡</div>
      </div>
      <div class={`dashboard-item ${stressStats.avgResponseTime <= 50 ? 'excellent' : stressStats.avgResponseTime <= 100 ? 'good' : 'warning'}`}>
        <div class="dashboard-value">{stressStats.avgResponseTime.toFixed(1)}ms</div>
        <div class="dashboard-label">å¹³å‡å“åº”æ—¶é—´</div>
      </div>
      <div class="dashboard-item good">
        <div class="dashboard-value">{stressStats.passedTests}/{stressStats.totalTests}</div>
        <div class="dashboard-label">é€šè¿‡æµ‹è¯•</div>
      </div>
      <div class="dashboard-item">
        <div class="dashboard-value">{(stressStats.totalDuration / 1000).toFixed(1)}s</div>
        <div class="dashboard-label">æ€»æµ‹è¯•æ—¶é—´</div>
      </div>
    </div>
  </div>

  <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€ -->
  <div class="system-health">
    <h2>ğŸ¥ ç³»ç»Ÿå¥åº·çŠ¶æ€</h2>
    <div class="health-grid">
      <div class={`health-item ${systemHealth.memoryUsage <= 30 ? 'healthy' : systemHealth.memoryUsage <= 50 ? 'warning' : 'critical'}`}>
        <h4>ğŸ’¾ å†…å­˜ä½¿ç”¨</h4>
        <div>å½“å‰ä½¿ç”¨: {systemHealth.memoryUsage.toFixed(1)}MB</div>
        <div>çŠ¶æ€: {systemHealth.memoryUsage <= 30 ? 'å¥åº·' : systemHealth.memoryUsage <= 50 ? 'è­¦å‘Š' : 'ä¸¥é‡'}</div>
      </div>
      
      <div class={`health-item ${systemHealth.cacheStats.hitRate >= 80 ? 'healthy' : systemHealth.cacheStats.hitRate >= 60 ? 'warning' : 'critical'}`}>
        <h4>ğŸ“¦ ç¼“å­˜çŠ¶æ€</h4>
        <div>å‘½ä¸­ç‡: {systemHealth.cacheStats.hitRate.toFixed(1)}%</div>
        <div>ç¼“å­˜é¡¹: {systemHealth.cacheStats.cacheSize}</div>
      </div>
      
      <div class={`health-item ${systemHealth.localStorageStats.hitRate >= 70 ? 'healthy' : systemHealth.localStorageStats.hitRate >= 50 ? 'warning' : 'critical'}`}>
        <h4>ğŸ’¿ æœ¬åœ°å­˜å‚¨</h4>
        <div>å‘½ä¸­ç‡: {systemHealth.localStorageStats.hitRate.toFixed(1)}%</div>
        <div>å­˜å‚¨é¡¹: {systemHealth.localStorageStats.totalItems}</div>
      </div>
      
      <div class={`health-item ${systemHealth.performanceScore >= 80 ? 'healthy' : systemHealth.performanceScore >= 60 ? 'warning' : 'critical'}`}>
        <h4>âš¡ æ€§èƒ½è¯„åˆ†</h4>
        <div>è¯„åˆ†: {systemHealth.performanceScore}/100</div>
        <div>ç³»ç»Ÿè¯„åˆ†: {systemHealth.systemScore}/100</div>
      </div>
    </div>
  </div>

  <!-- å‹åŠ›æµ‹è¯•ç»“æœ -->
  <div class="test-results">
    {stressTests.map((test, index) => (
      <div class="test-card">
        <div class={`test-header ${test.success ? 'success' : 'failure'}`}>
          <div class="test-name">
            <span>{test.success ? 'âœ…' : 'âŒ'}</span>
            {test.name}
          </div>
          <div class="test-duration">{test.duration.toFixed(0)}ms</div>
        </div>
        
        <div class="test-metrics">
          <div class="metric-item">
            <div class="metric-value">{test.metrics.throughput.toFixed(1)}</div>
            <div class="metric-label">ååé‡ (ops/s)</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{test.metrics.errorRate.toFixed(1)}%</div>
            <div class="metric-label">é”™è¯¯ç‡</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{test.metrics.avgResponseTime.toFixed(1)}ms</div>
            <div class="metric-label">å¹³å‡å“åº”</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{test.metrics.maxResponseTime.toFixed(1)}ms</div>
            <div class="metric-label">æœ€å¤§å“åº”</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">{test.metrics.minResponseTime.toFixed(1)}ms</div>
            <div class="metric-label">æœ€å°å“åº”</div>
          </div>
        </div>
        
        <div class="test-details">
          <strong>æµ‹è¯•è¯¦æƒ…:</strong>
          <pre>{JSON.stringify(test.details, null, 2)}</pre>
        </div>
        
        {test.error && (
          <div class="error-message">
            <strong>é”™è¯¯ä¿¡æ¯:</strong> {test.error}
          </div>
        )}
      </div>
    ))}
  </div>

  <script define:vars={{ stressTests, stressStats, systemHealth }} is:inline>
    console.log('ğŸ”¥ ç³»ç»Ÿå‹åŠ›æµ‹è¯•é¡µé¢å·²åŠ è½½');
    console.log('ğŸ“Š å‹åŠ›æµ‹è¯•ç»“æœ:', JSON.stringify(stressTests, null, 2));
    console.log('ğŸ“Š å‹åŠ›æµ‹è¯•ç»Ÿè®¡:', JSON.stringify(stressStats, null, 2));
    console.log('ğŸ¥ ç³»ç»Ÿå¥åº·çŠ¶æ€:', JSON.stringify(systemHealth, null, 2));
  </script>
</body>
</html>

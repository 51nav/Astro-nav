---
import Layout from '../layouts/Layout.astro';
---

<Layout 
  title="è¡¨æ ¼å¯¼å…¥å·¥å…· - ä»Excel/CSVç”Ÿæˆé…ç½®æ–‡ä»¶"
  description="æ”¯æŒä»Excelæˆ–CSVè¡¨æ ¼å¯¼å…¥æ•°æ®ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¼èˆªç½‘ç«™é…ç½®æ–‡ä»¶"
>
  <div class="import-container">
    <header class="import-header">
      <h1>ğŸ“Š è¡¨æ ¼å¯¼å…¥å·¥å…·</h1>
      <p>ä»Excelæˆ–CSVè¡¨æ ¼å¯¼å…¥æ•°æ®ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¼èˆªç½‘ç«™é…ç½®æ–‡ä»¶</p>
    </header>

    <div class="import-steps">
      <div class="step" data-step="1">
        <div class="step-number">1</div>
        <div class="step-content">
          <h3>ä¸‹è½½æ¨¡æ¿</h3>
          <p>ä¸‹è½½æ ‡å‡†çš„è¡¨æ ¼æ¨¡æ¿æ–‡ä»¶</p>
          <div class="template-downloads">
            <a href="/templates/menu-template.csv" download class="download-btn">
              ğŸ“‹ èœå•æ¨¡æ¿ (CSV)
            </a>
            <a href="/templates/site-template.csv" download class="download-btn">
              ğŸŒ ç½‘ç«™æ¨¡æ¿ (CSV)
            </a>
          </div>
        </div>
      </div>

      <div class="step" data-step="2">
        <div class="step-number">2</div>
        <div class="step-content">
          <h3>å¡«å†™æ•°æ®</h3>
          <p>æŒ‰ç…§æ¨¡æ¿æ ¼å¼å¡«å†™æ‚¨çš„å¯¼èˆªæ•°æ®</p>
          <div class="format-info">
            <div class="info-item">
              <strong>èœå•è¡¨æ ¼ï¼š</strong>å®šä¹‰å·¦ä¾§å¯¼èˆªç»“æ„
            </div>
            <div class="info-item">
              <strong>ç½‘ç«™è¡¨æ ¼ï¼š</strong>å¡«å……å³ä¾§ç½‘ç«™å†…å®¹
            </div>
          </div>
        </div>
      </div>

      <div class="step" data-step="3">
        <div class="step-number">3</div>
        <div class="step-content">
          <h3>ä¸Šä¼ æ–‡ä»¶</h3>
          <p>ä¸Šä¼ å¡«å†™å¥½çš„è¡¨æ ¼æ–‡ä»¶è¿›è¡Œè§£æ</p>
          
          <div class="upload-section">
            <div class="upload-group">
              <label for="menu-file">ğŸ“‹ èœå•è¡¨æ ¼æ–‡ä»¶</label>
              <input 
                type="file" 
                id="menu-file" 
                accept=".csv,.xlsx"
                class="file-input"
              />
              <div class="file-info" id="menu-file-info"></div>
            </div>

            <div class="upload-group">
              <label for="site-file">ğŸŒ ç½‘ç«™è¡¨æ ¼æ–‡ä»¶</label>
              <input 
                type="file" 
                id="site-file" 
                accept=".csv,.xlsx"
                class="file-input"
              />
              <div class="file-info" id="site-file-info"></div>
            </div>
          </div>

          <button id="parse-btn" class="parse-btn" disabled>
            ğŸ”„ è§£æè¡¨æ ¼æ•°æ®
          </button>
        </div>
      </div>

      <div class="step" data-step="4">
        <div class="step-number">4</div>
        <div class="step-content">
          <h3>ç½‘ç«™ä¿¡æ¯</h3>
          <p>é…ç½®æ‚¨çš„ç½‘ç«™åŸºæœ¬ä¿¡æ¯</p>
          
          <div class="site-config">
            <div class="config-group">
              <label for="site-title">ç½‘ç«™æ ‡é¢˜</label>
              <input 
                type="text" 
                id="site-title" 
                placeholder="æˆ‘çš„å¯¼èˆªç½‘ç«™"
                value="Affiliateå¯¼èˆª"
              />
            </div>
            
            <div class="config-group">
              <label for="site-description">ç½‘ç«™æè¿°</label>
              <input 
                type="text" 
                id="site-description" 
                placeholder="ä¸“ä¸šçš„å¯¼èˆªå¹³å°"
                value="ä¸“ä¸šçš„Affiliateè¥é”€å¯¼èˆªç½‘ç«™"
              />
            </div>
            
            <div class="config-group">
              <label for="site-logo">Logoæ–‡å­—</label>
              <input 
                type="text" 
                id="site-logo" 
                placeholder="MyNav"
                value="Affiliateå¯¼èˆª"
              />
            </div>
          </div>
        </div>
      </div>

      <div class="step" data-step="5">
        <div class="step-number">5</div>
        <div class="step-content">
          <h3>ç”Ÿæˆé…ç½®</h3>
          <p>ç”Ÿæˆæœ€ç»ˆçš„é…ç½®æ–‡ä»¶</p>
          
          <button id="generate-btn" class="generate-btn" disabled>
            ğŸš€ ç”Ÿæˆé…ç½®æ–‡ä»¶
          </button>
        </div>
      </div>
    </div>

    <div class="result-section" id="result-section" style="display: none;">
      <h2>ğŸ“‹ è§£æç»“æœ</h2>
      <div id="result-content"></div>
    </div>

    <div class="preview-section" id="preview-section" style="display: none;">
      <h2>ğŸ‘€ é…ç½®é¢„è§ˆ</h2>
      <div class="preview-actions">
        <button id="download-config-btn" class="download-btn">
          ğŸ’¾ ä¸‹è½½é…ç½®æ–‡ä»¶
        </button>
        <button id="copy-config-btn" class="copy-btn">
          ğŸ“‹ å¤åˆ¶é…ç½®
        </button>
      </div>
      <pre id="config-preview"></pre>
    </div>

    <div class="help-section">
      <h2>ğŸ“š ä½¿ç”¨è¯´æ˜</h2>
      <div class="help-content">
        <div class="help-item">
          <h4>ğŸ“‹ èœå•è¡¨æ ¼æ ¼å¼</h4>
          <p>å®šä¹‰å·¦ä¾§å¯¼èˆªèœå•çš„å±‚çº§ç»“æ„ï¼Œæ”¯æŒå•çº§å’Œå¤šçº§èœå•ã€‚</p>
          <ul>
            <li><code>menuId</code>: èœå•å”¯ä¸€æ ‡è¯†</li>
            <li><code>menuName</code>: èœå•æ˜¾ç¤ºåç§°</li>
            <li><code>menuIcon</code>: èœå•å›¾æ ‡ (mdi:å‰ç¼€)</li>
            <li><code>menuType</code>: single æˆ– tabs</li>
            <li><code>parentMenuId</code>: çˆ¶èœå•ID (å­èœå•ç”¨)</li>
            <li><code>sortOrder</code>: æ’åºé¡ºåº</li>
          </ul>
        </div>
        
        <div class="help-item">
          <h4>ğŸŒ ç½‘ç«™è¡¨æ ¼æ ¼å¼</h4>
          <p>å¡«å……å„ä¸ªèœå•ä¸‹çš„å…·ä½“ç½‘ç«™æ•°æ®ã€‚</p>
          <ul>
            <li><code>menuId</code>: æ‰€å±èœå•ID</li>
            <li><code>title</code>: ç½‘ç«™æ ‡é¢˜</li>
            <li><code>description</code>: ç®€çŸ­æè¿°</li>
            <li><code>advantages</code>: ä¼˜åŠ¿ç‰¹ç‚¹ (åˆ†å·åˆ†éš”)</li>
            <li><code>pros/cons</code>: ä¼˜ç¼ºç‚¹ (åˆ†å·åˆ†éš”)</li>
            <li><code>tips</code>: ä½¿ç”¨æŠ€å·§ (åˆ†å·åˆ†éš”)</li>
          </ul>
        </div>
        
        <div class="help-item">
          <h4>âš ï¸ æ³¨æ„äº‹é¡¹</h4>
          <ul>
            <li>CSVæ–‡ä»¶è¯·ä½¿ç”¨UTF-8ç¼–ç </li>
            <li>å¤šä¸ªå€¼ç”¨è‹±æ–‡åˆ†å· <code>;</code> åˆ†éš”</li>
            <li>menuIdå¿…é¡»åœ¨ä¸¤ä¸ªè¡¨æ ¼ä¸­ä¿æŒä¸€è‡´</li>
            <li>çˆ¶èœå•å¿…é¡»åœ¨å­èœå•ä¹‹å‰å®šä¹‰</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  .import-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .import-header {
    text-align: center;
    margin-bottom: 3rem;
  }

  .import-header h1 {
    font-size: 2.5rem;
    color: #2937f0;
    margin-bottom: 1rem;
  }

  .import-header p {
    font-size: 1.2rem;
    color: #666;
  }

  .import-steps {
    display: flex;
    flex-direction: column;
    gap: 2rem;
    margin-bottom: 3rem;
  }

  .step {
    display: flex;
    gap: 1.5rem;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    border-left: 4px solid #e0e0e0;
    transition: all 0.3s ease;
  }

  .step.active {
    border-left-color: #2937f0;
    box-shadow: 0 4px 20px rgba(41, 55, 240, 0.1);
  }

  .step-number {
    width: 40px;
    height: 40px;
    background: #f0f0f0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #666;
    flex-shrink: 0;
  }

  .step.active .step-number {
    background: #2937f0;
    color: white;
  }

  .step-content {
    flex: 1;
  }

  .step-content h3 {
    margin: 0 0 0.5rem 0;
    color: #333;
  }

  .step-content p {
    margin: 0 0 1rem 0;
    color: #666;
  }

  .template-downloads {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .download-btn, .parse-btn, .generate-btn, .copy-btn {
    padding: 0.75rem 1.5rem;
    background: #2937f0;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .download-btn:hover, .parse-btn:hover, .generate-btn:hover, .copy-btn:hover {
    background: #1e2ad8;
    transform: translateY(-2px);
  }

  .parse-btn:disabled, .generate-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
  }

  .format-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .info-item {
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 0.9rem;
  }

  .upload-section {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .upload-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .upload-group label {
    font-weight: 500;
    color: #333;
  }

  .file-input {
    padding: 0.75rem;
    border: 2px dashed #ddd;
    border-radius: 8px;
    background: #fafafa;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .file-input:hover {
    border-color: #2937f0;
    background: #f0f2ff;
  }

  .file-info {
    font-size: 0.85rem;
    color: #666;
    min-height: 1.2rem;
  }

  .site-config {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .config-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .config-group label {
    font-weight: 500;
    color: #333;
  }

  .config-group input {
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 1rem;
  }

  .config-group input:focus {
    outline: none;
    border-color: #2937f0;
    box-shadow: 0 0 0 3px rgba(41, 55, 240, 0.1);
  }

  .result-section, .preview-section {
    margin: 2rem 0;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }

  .preview-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  #config-preview {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    line-height: 1.4;
    max-height: 500px;
    overflow-y: auto;
  }

  .help-section {
    margin-top: 3rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 12px;
  }

  .help-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
  }

  .help-item h4 {
    color: #2937f0;
    margin-bottom: 0.5rem;
  }

  .help-item ul {
    margin: 0.5rem 0;
    padding-left: 1.5rem;
  }

  .help-item li {
    margin-bottom: 0.25rem;
  }

  .help-item code {
    background: #e9ecef;
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
  }

  @media (max-width: 768px) {
    .import-container {
      padding: 1rem;
    }
    
    .step {
      flex-direction: column;
      gap: 1rem;
    }
    
    .template-downloads {
      flex-direction: column;
    }
    
    .help-content {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  // å¯¼å…¥è¡¨æ ¼è§£æåŠŸèƒ½
  import { 
    parseMenuExcelFile, 
    parseMenuCSVFile,
    parseSiteExcelFile,
    parseSiteCSVFile,
    generateConfig
  } from '../utils/tableImport';
  
  // å…¨å±€å˜é‡
  let menuData: any[] = [];
  let siteData: any[] = [];
  let currentStep = 1;
  
  // DOMå…ƒç´ 
  const menuFileInput = document.getElementById('menu-file') as HTMLInputElement;
  const siteFileInput = document.getElementById('site-file') as HTMLInputElement;
  const parseBtn = document.getElementById('parse-btn') as HTMLButtonElement;
  const generateBtn = document.getElementById('generate-btn') as HTMLButtonElement;
  const resultSection = document.getElementById('result-section') as HTMLElement;
  const previewSection = document.getElementById('preview-section') as HTMLElement;
  
  // æ›´æ–°æ­¥éª¤çŠ¶æ€
  function updateStep(step: number) {
    currentStep = step;
    document.querySelectorAll('.step').forEach((el, index) => {
      if (index + 1 <= step) {
        el.classList.add('active');
      } else {
        el.classList.remove('active');
      }
    });
  }
  
  // æ–‡ä»¶é€‰æ‹©å¤„ç†
  menuFileInput.addEventListener('change', handleMenuFileSelect);
  siteFileInput.addEventListener('change', handleSiteFileSelect);
  
  function handleMenuFileSelect(event: Event) {
    const file = (event.target as HTMLInputElement).files?.[0];
    const infoEl = document.getElementById('menu-file-info');
    
    if (file && infoEl) {
      infoEl.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      checkFilesReady();
    }
  }
  
  function handleSiteFileSelect(event: Event) {
    const file = (event.target as HTMLInputElement).files?.[0];
    const infoEl = document.getElementById('site-file-info');
    
    if (file && infoEl) {
      infoEl.textContent = `å·²é€‰æ‹©: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      checkFilesReady();
    }
  }
  
  function checkFilesReady() {
    const menuFile = menuFileInput.files?.[0];
    const siteFile = siteFileInput.files?.[0];
    
    if (menuFile && siteFile) {
      parseBtn.disabled = false;
      updateStep(3);
    }
  }
  
  // è§£ææŒ‰é’®å¤„ç†
  parseBtn.addEventListener('click', async () => {
    const menuFile = menuFileInput.files?.[0];
    const siteFile = siteFileInput.files?.[0];
    
    if (!menuFile || !siteFile) return;
    
    parseBtn.textContent = 'ğŸ”„ è§£æä¸­...';
    parseBtn.disabled = true;
    
    try {
      // è§£æèœå•æ–‡ä»¶
      const menuResult = await parseFile(menuFile, 'menu');
      if (!menuResult.success) {
        throw new Error(`èœå•æ–‡ä»¶è§£æå¤±è´¥: ${menuResult.error}`);
      }
      menuData = menuResult.data || [];
      
      // è§£æç½‘ç«™æ–‡ä»¶
      const siteResult = await parseFile(siteFile, 'site');
      if (!siteResult.success) {
        throw new Error(`ç½‘ç«™æ–‡ä»¶è§£æå¤±è´¥: ${siteResult.error}`);
      }
      siteData = siteResult.data || [];
      
      // æ˜¾ç¤ºè§£æç»“æœ
      showParseResult(menuResult, siteResult);
      updateStep(4);
      generateBtn.disabled = false;
      
    } catch (error) {
      showError(error instanceof Error ? error.message : 'è§£æå¤±è´¥');
    } finally {
      parseBtn.textContent = 'ğŸ”„ è§£æè¡¨æ ¼æ•°æ®';
      parseBtn.disabled = false;
    }
  });
  
  async function parseFile(file: File, type: 'menu' | 'site') {
    const isExcel = file.name.endsWith('.xlsx');
    
    if (type === 'menu') {
      return isExcel ? parseMenuExcelFile(file) : parseMenuCSVFile(file);
    } else {
      return isExcel ? parseSiteExcelFile(file) : parseSiteCSVFile(file);
    }
  }
  
  function showParseResult(menuResult: any, siteResult: any) {
    const resultContent = document.getElementById('result-content');
    if (!resultContent) return;
    
    resultContent.innerHTML = `
      <div class="parse-success">
        <h3>âœ… è§£ææˆåŠŸ</h3>
        <div class="result-stats">
          <div class="stat-item">
            <strong>èœå•æ•°æ®:</strong> ${menuResult.rowCount} æ¡è®°å½•
          </div>
          <div class="stat-item">
            <strong>ç½‘ç«™æ•°æ®:</strong> ${siteResult.rowCount} æ¡è®°å½•
          </div>
        </div>
      </div>
    `;
    
    resultSection.style.display = 'block';
  }
  
  function showError(message: string) {
    const resultContent = document.getElementById('result-content');
    if (!resultContent) return;
    
    resultContent.innerHTML = `
      <div class="parse-error">
        <h3>âŒ è§£æå¤±è´¥</h3>
        <p>${message}</p>
      </div>
    `;
    
    resultSection.style.display = 'block';
  }
  
  // ç”Ÿæˆé…ç½®æŒ‰é’®å¤„ç†
  generateBtn.addEventListener('click', () => {
    const siteTitle = (document.getElementById('site-title') as HTMLInputElement).value;
    const siteDescription = (document.getElementById('site-description') as HTMLInputElement).value;
    const siteLogo = (document.getElementById('site-logo') as HTMLInputElement).value;
    
    try {
      const config = generateConfig(menuData, siteData, {
        title: siteTitle,
        description: siteDescription,
        logoText: siteLogo
      });
      
      showConfigPreview(config);
      updateStep(5);
      
    } catch (error) {
      showError(`é…ç½®ç”Ÿæˆå¤±è´¥: ${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}`);
    }
  });
  
  function showConfigPreview(config: any) {
    const configPreview = document.getElementById('config-preview');
    if (!configPreview) return;
    
    configPreview.textContent = JSON.stringify(config, null, 2);
    previewSection.style.display = 'block';
    
    // è®¾ç½®ä¸‹è½½å’Œå¤åˆ¶æŒ‰é’®
    setupPreviewActions(config);
  }
  
  function setupPreviewActions(config: any) {
    const downloadBtn = document.getElementById('download-config-btn');
    const copyBtn = document.getElementById('copy-config-btn');
    
    if (downloadBtn) {
      downloadBtn.addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'config.json';
        a.click();
        URL.revokeObjectURL(url);
      });
    }
    
    if (copyBtn) {
      copyBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(JSON.stringify(config, null, 2));
          copyBtn.textContent = 'âœ… å·²å¤åˆ¶';
          setTimeout(() => {
            copyBtn.textContent = 'ğŸ“‹ å¤åˆ¶é…ç½®';
          }, 2000);
        } catch (error) {
          console.error('å¤åˆ¶å¤±è´¥:', error);
        }
      });
    }
  }
  
  // åˆå§‹åŒ–
  updateStep(1);
</script>
</Layout>

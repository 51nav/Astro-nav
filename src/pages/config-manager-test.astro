---
import Layout from '../layouts/Layout.astro';
---

<Layout title="ConfigManager æµ‹è¯•é¡µé¢" description="æµ‹è¯•æ–°çš„ConfigManageråŠŸèƒ½">
  <div class="test-container">
    <div class="test-header">
      <h1>ğŸ§ª ConfigManager æµ‹è¯•é¡µé¢</h1>
      <p>æµ‹è¯•æ–°é‡æ„çš„ConfigManageråŠŸèƒ½å’Œæ€§èƒ½</p>
    </div>

    <div class="test-controls">
      <div class="config-selector">
        <label for="configPath">é€‰æ‹©é…ç½®æ–‡ä»¶:</label>
        <select id="configPath" class="config-select">
          <option value="/config.json">ä¼ ç»Ÿæ ¼å¼ (config.json)</option>
          <option value="/config-optimized.json">ä¼˜åŒ–æ ¼å¼ (config-optimized.json)</option>
        </select>
      </div>

      <div class="button-group">
        <button id="loadConfigBtn" class="test-btn primary">
          ğŸ”„ åŠ è½½é…ç½®
        </button>
        <button id="reloadConfigBtn" class="test-btn">
          ğŸ” é‡æ–°åŠ è½½
        </button>
        <button id="showStatsBtn" class="test-btn">
          ğŸ“Š æ˜¾ç¤ºç»Ÿè®¡
        </button>
        <button id="clearResultsBtn" class="test-btn secondary">
          ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
        </button>
      </div>
    </div>

    <div class="test-results">
      <div class="result-section">
        <h3>ğŸ“‹ åŠ è½½ç»“æœ</h3>
        <div id="loadResult" class="result-content">
          <p class="placeholder">ç‚¹å‡»"åŠ è½½é…ç½®"å¼€å§‹æµ‹è¯•...</p>
        </div>
      </div>

      <div class="result-section">
        <h3>ğŸ” é…ç½®æ£€æµ‹</h3>
        <div id="detectionResult" class="result-content">
          <p class="placeholder">ç­‰å¾…é…ç½®æ£€æµ‹ç»“æœ...</p>
        </div>
      </div>

      <div class="result-section">
        <h3>ğŸ“Š æ€§èƒ½æŒ‡æ ‡</h3>
        <div id="performanceResult" class="result-content">
          <p class="placeholder">ç­‰å¾…æ€§èƒ½æ•°æ®...</p>
        </div>
      </div>

      <div class="result-section">
        <h3>ğŸ“ˆ é…ç½®ç»Ÿè®¡</h3>
        <div id="statsResult" class="result-content">
          <p class="placeholder">ç­‰å¾…ç»Ÿè®¡æ•°æ®...</p>
        </div>
      </div>
    </div>

    <div class="test-info">
      <h3>â„¹ï¸ æµ‹è¯•è¯´æ˜</h3>
      <ul>
        <li><strong>åŠ è½½é…ç½®</strong>: æµ‹è¯•ConfigManagerçš„é…ç½®åŠ è½½åŠŸèƒ½</li>
        <li><strong>æ ¼å¼æ£€æµ‹</strong>: éªŒè¯è‡ªåŠ¨æ£€æµ‹ä¼ ç»Ÿ/ä¼˜åŒ–é…ç½®æ ¼å¼</li>
        <li><strong>æ€§èƒ½ç›‘æ§</strong>: æŸ¥çœ‹åŠ è½½æ—¶é—´å’Œå„é˜¶æ®µè€—æ—¶</li>
        <li><strong>ç»Ÿè®¡ä¿¡æ¯</strong>: æ˜¾ç¤ºé…ç½®çš„è¯¦ç»†ç»Ÿè®¡æ•°æ®</li>
      </ul>
    </div>
  </div>
</Layout>

<script>
  import { ConfigManager } from '../utils/ConfigManager';

  // è·å–DOMå…ƒç´ 
  const loadConfigBtn = document.getElementById('loadConfigBtn') as HTMLButtonElement;
  const reloadConfigBtn = document.getElementById('reloadConfigBtn') as HTMLButtonElement;
  const showStatsBtn = document.getElementById('showStatsBtn') as HTMLButtonElement;
  const clearResultsBtn = document.getElementById('clearResultsBtn') as HTMLButtonElement;

  const loadResult = document.getElementById('loadResult') as HTMLElement;
  const detectionResult = document.getElementById('detectionResult') as HTMLElement;
  const performanceResult = document.getElementById('performanceResult') as HTMLElement;
  const statsResult = document.getElementById('statsResult') as HTMLElement;

  // åˆ›å»ºConfigManagerå®ä¾‹
  const configManager = ConfigManager.getInstance();

  // åŠ è½½é…ç½®
  loadConfigBtn.addEventListener('click', async () => {
    loadConfigBtn.disabled = true;
    loadConfigBtn.textContent = 'â³ åŠ è½½ä¸­...';
    
    try {
      const result = await configManager.loadConfig();
      
      // æ˜¾ç¤ºåŠ è½½ç»“æœ
      loadResult.innerHTML = `
        <div class="result-item ${result.success ? 'success' : 'error'}">
          <h4>${result.success ? 'âœ… åŠ è½½æˆåŠŸ' : 'âŒ åŠ è½½å¤±è´¥'}</h4>
          <p><strong>è€—æ—¶:</strong> ${result.loadTime.toFixed(2)}ms</p>
          <p><strong>æ ¼å¼:</strong> ${result.isOptimized ? 'ä¼˜åŒ–æ ¼å¼' : 'ä¼ ç»Ÿæ ¼å¼'}</p>
          ${result.error ? `<p class="error"><strong>é”™è¯¯:</strong> ${result.error}</p>` : ''}
        </div>
      `;

      // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
      if (result.detection) {
        const detection = result.detection;
        detectionResult.innerHTML = `
          <div class="result-item">
            <h4>ğŸ” æ ¼å¼æ£€æµ‹ç»“æœ</h4>
            <p><strong>æ˜¯å¦ä¼˜åŒ–:</strong> ${detection.isOptimized ? 'æ˜¯' : 'å¦'}</p>
            <p><strong>ç½®ä¿¡åº¦:</strong> ${(detection.confidence * 100).toFixed(1)}%</p>
            <p><strong>ä¼˜åŒ–å­—æ®µ:</strong> ${detection.hasOptimizationField ? 'æœ‰' : 'æ— '}</p>
            <p><strong>åˆ†ç±»ç´¢å¼•:</strong> ${detection.hasCategoryIndexes ? 'æœ‰' : 'æ— '}</p>
            <p><strong>é¢„è§ˆç½‘ç«™:</strong> ${detection.hasPreviewSites ? 'æœ‰' : 'æ— '}</p>
            <p><strong>ä¼°ç®—åˆ†ç±»æ•°:</strong> ${detection.estimatedCategories}</p>
          </div>
        `;
      }

      // æ˜¾ç¤ºæ€§èƒ½æŒ‡æ ‡
      const metrics = configManager.getPerformanceMetrics();
      performanceResult.innerHTML = `
        <div class="result-item">
          <h4>âš¡ æ€§èƒ½æŒ‡æ ‡</h4>
          <p><strong>é…ç½®åŠ è½½:</strong> ${metrics.configLoadTime.toFixed(2)}ms</p>
          <p><strong>æ ¼å¼æ£€æµ‹:</strong> ${metrics.detectionTime.toFixed(2)}ms</p>
          <p><strong>æ ¼å¼è½¬æ¢:</strong> ${metrics.conversionTime.toFixed(2)}ms</p>
          <p><strong>æ€»è€—æ—¶:</strong> ${metrics.totalLoadTime.toFixed(2)}ms</p>
        </div>
      `;

      // è‡ªåŠ¨æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
      showStats();

    } catch (error) {
      loadResult.innerHTML = `
        <div class="result-item error">
          <h4>âŒ åŠ è½½å¼‚å¸¸</h4>
          <p class="error">${error instanceof Error ? error.message : 'æœªçŸ¥é”™è¯¯'}</p>
        </div>
      `;
    } finally {
      loadConfigBtn.disabled = false;
      loadConfigBtn.textContent = 'ğŸ”„ åŠ è½½é…ç½®';
    }
  });

  // é‡æ–°åŠ è½½é…ç½®
  reloadConfigBtn.addEventListener('click', async () => {
    reloadConfigBtn.disabled = true;
    reloadConfigBtn.textContent = 'â³ é‡æ–°åŠ è½½ä¸­...';
    
    try {
      await configManager.reloadConfig();
      loadConfigBtn.click(); // è§¦å‘åŠ è½½æ˜¾ç¤º
    } finally {
      reloadConfigBtn.disabled = false;
      reloadConfigBtn.textContent = 'ğŸ” é‡æ–°åŠ è½½';
    }
  });

  // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
  showStatsBtn.addEventListener('click', showStats);

  function showStats() {
    const stats = configManager.getConfigStats();
    
    if (!stats) {
      statsResult.innerHTML = `
        <div class="result-item warning">
          <p>âš ï¸ è¯·å…ˆåŠ è½½é…ç½®</p>
        </div>
      `;
      return;
    }

    statsResult.innerHTML = `
      <div class="result-item">
        <h4>ğŸ“ˆ é…ç½®ç»Ÿè®¡</h4>
        <p><strong>é…ç½®æ ¼å¼:</strong> ${stats.format}</p>
        <p><strong>åŠ è½½çŠ¶æ€:</strong> ${stats.loadingState}</p>
        <p><strong>èœå•é¡¹æ•°:</strong> ${stats.menuItemCount}</p>
        <p><strong>æ€»ç½‘ç«™æ•°:</strong> ${stats.totalSites}</p>
        <p><strong>æ‡’åŠ è½½é¡¹:</strong> ${stats.lazyLoadedItems}</p>
        ${stats.optimization ? `
          <div class="optimization-stats">
            <h5>ğŸ¯ ä¼˜åŒ–ä¿¡æ¯</h5>
            <p><strong>æ€»åˆ†ç±»æ•°:</strong> ${stats.optimization.totalCategories}</p>
            <p><strong>é¢„è§ˆæ•°é‡:</strong> ${stats.optimization.previewCount}</p>
            <p><strong>æ–‡ä»¶å¤§å°:</strong> ${stats.optimization.fileSizeKB}KB</p>
            <p><strong>å‹ç¼©æ¯”ä¾‹:</strong> ${stats.optimization.compressionRatio}%</p>
          </div>
        ` : ''}
      </div>
    `;
  }

  // æ¸…ç©ºç»“æœ
  clearResultsBtn.addEventListener('click', () => {
    loadResult.innerHTML = '<p class="placeholder">ç‚¹å‡»"åŠ è½½é…ç½®"å¼€å§‹æµ‹è¯•...</p>';
    detectionResult.innerHTML = '<p class="placeholder">ç­‰å¾…é…ç½®æ£€æµ‹ç»“æœ...</p>';
    performanceResult.innerHTML = '<p class="placeholder">ç­‰å¾…æ€§èƒ½æ•°æ®...</p>';
    statsResult.innerHTML = '<p class="placeholder">ç­‰å¾…ç»Ÿè®¡æ•°æ®...</p>';
  });
</script>

<style>
  .test-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }

  .test-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .test-header h1 {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .test-controls {
    display: flex;
    gap: 1rem;
    justify-content: center;
    margin-bottom: 2rem;
    flex-wrap: wrap;
  }

  .test-btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .test-btn.primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .test-btn.secondary {
    background: #f8f9fa;
    color: #6c757d;
    border: 2px solid #e9ecef;
  }

  .test-btn:not(.primary):not(.secondary) {
    background: #28a745;
    color: white;
  }

  .test-btn:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }

  .test-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  .test-results {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .result-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  .result-section h3 {
    margin-bottom: 1rem;
    color: #333;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 0.5rem;
  }

  .result-content {
    min-height: 100px;
  }

  .result-item {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .result-item.success {
    background: #d4edda;
    border-left: 4px solid #28a745;
  }

  .result-item.error {
    background: #f8d7da;
    border-left: 4px solid #dc3545;
  }

  .result-item.warning {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
  }

  .result-item:not(.success):not(.error):not(.warning) {
    background: #e3f2fd;
    border-left: 4px solid #2196f3;
  }

  .result-item h4, .result-item h5 {
    margin-bottom: 0.5rem;
    color: #333;
  }

  .result-item p {
    margin-bottom: 0.25rem;
    line-height: 1.5;
  }

  .error {
    color: #dc3545;
    font-weight: 600;
  }

  .placeholder {
    color: #6c757d;
    font-style: italic;
    text-align: center;
    padding: 2rem;
  }

  .optimization-stats {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #dee2e6;
  }

  .test-info {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid #17a2b8;
  }

  .test-info h3 {
    margin-bottom: 1rem;
    color: #333;
  }

  .test-info ul {
    list-style: none;
    padding: 0;
  }

  .test-info li {
    margin-bottom: 0.5rem;
    padding-left: 1rem;
    position: relative;
  }

  .test-info li::before {
    content: "â€¢";
    color: #17a2b8;
    font-weight: bold;
    position: absolute;
    left: 0;
  }

  @media (max-width: 768px) {
    .test-container {
      padding: 1rem;
    }
    
    .test-controls {
      flex-direction: column;
      align-items: center;
    }
    
    .test-btn {
      width: 100%;
      max-width: 300px;
    }
    
    .test-results {
      grid-template-columns: 1fr;
    }
  }
</style>
